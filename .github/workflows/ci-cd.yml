name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      skip_tests:
        description: 'Skip validation tests'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  checks: write

env:
  DOTNET_VERSION: '10.x'
  BUILD_CONFIGURATION: 'Release'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_NOLOGO: 'true'

jobs:
  build-dacpac:
    name: Build Database DACPAC
    runs-on: [self-hosted, windows, sql-server]
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build DACPAC with MSBuild
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          Write-Host "Building SQL Database Project..."
          
          $projectPath = Join-Path $env:GITHUB_WORKSPACE "src\Hartonomous.Database\Hartonomous.Database.sqlproj"
          
          # Try multiple MSBuild discovery methods
          $msbuildPath = $null
          
          # Method 1: vswhere (most reliable for installed VS)
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (Test-Path $vswhere) {
            $msbuildPath = & $vswhere -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
          }
          
          # Method 2: Direct VS 2022 paths
          if (-not $msbuildPath) {
            $vsPaths = @(
              "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
              "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe"
              "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
              "${env:ProgramFiles}\Microsoft Visual Studio\18\Insiders\MSBuild\Current\Bin\MSBuild.exe"
            )
            foreach ($path in $vsPaths) {
              if (Test-Path $path) {
                $msbuildPath = $path
                break
              }
            }
          }
          
          # Method 3: Build Tools standalone installation
          if (-not $msbuildPath) {
            $buildToolsPath = "${env:ProgramFiles}\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
            if (Test-Path $buildToolsPath) {
              $msbuildPath = $buildToolsPath
            }
          }
          
          if (-not $msbuildPath) {
            throw "MSBuild not found. Install Visual Studio 2022 or VS Build Tools with MSBuild component."
          }
          
          Write-Host "Using MSBuild: $msbuildPath"
          
          & $msbuildPath $projectPath `
            /p:Configuration=Release `
            /t:Build `
            /v:minimal
          
          if ($LASTEXITCODE -ne 0) {
            throw "DACPAC build failed with exit code $LASTEXITCODE"
          }
          
          # Find the built DACPAC
          $dacpacPath = Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "src\Hartonomous.Database") -Recurse -Filter "Hartonomous.Database.dacpac" | Select-Object -First 1
          
          if (-not $dacpacPath) {
            throw "DACPAC file not found after build"
          }
          
          Write-Host "‚úì DACPAC built: $($dacpacPath.FullName)"
          
          # Copy to artifacts directory for upload
          $artifactDir = Join-Path $env:GITHUB_WORKSPACE "artifacts\database"
          New-Item -ItemType Directory -Path $artifactDir -Force | Out-Null
          Copy-Item -Path $dacpacPath.FullName -Destination $artifactDir -Force
          
          Write-Host "‚úì DACPAC copied to artifacts"
      
      - name: Upload DACPAC artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-dacpac
          path: artifacts/database/
          retention-days: 7
      
      - name: Upload CLR dependencies
        uses: actions/upload-artifact@v4
        with:
          name: clr-dependencies
          path: dependencies/
          retention-days: 7
      
      - name: Upload deployment scripts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-scripts
          path: scripts/
          retention-days: 7

  deploy-database:
    needs: build-dacpac
    runs-on: [self-hosted, windows, sql-server]
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download DACPAC Artifact
        uses: actions/download-artifact@v4
        with:
          name: database-dacpac
          path: ./artifacts/database

      - name: Download CLR Dependencies
        uses: actions/download-artifact@v4
        with:
          name: clr-dependencies
          path: ./dependencies

      - name: Download Deployment Scripts
        uses: actions/download-artifact@v4
        with:
          name: deployment-scripts
          path: ./scripts

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install SqlPackage
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Check if SqlPackage is already available
          $existing = Get-Command sqlpackage -ErrorAction SilentlyContinue
          if ($existing) {
            Write-Host "‚úì SqlPackage already installed at: $($existing.Source)"
            & sqlpackage /version
            exit 0
          }
          
          Write-Host "Installing SqlPackage via dotnet tool..."
          dotnet tool install -g microsoft.sqlpackage
          
          # Verify installation
          $installed = Get-Command sqlpackage -ErrorAction SilentlyContinue
          if ($installed) {
            Write-Host "‚úì SqlPackage installed successfully at: $($installed.Source)"
            & sqlpackage /version
          } else {
            throw "SqlPackage installation failed - not found in PATH after install"
          }
        shell: pwsh

      - name: Get Azure AD Access Token for SQL
        id: get_token
        run: |
          $token = (az account get-access-token --resource https://database.windows.net --query accessToken -o tsv)
          if (-not $token) {
            throw "Failed to retrieve Azure AD token for SQL Server."
          }
          echo "::add-mask::$token"
          echo "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        shell: pwsh

      - name: Execute Unified Database Deployment
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Dynamically locate the DACPAC
          $dacpacPath = Get-ChildItem -Path "./artifacts/database" -Filter "*.dacpac" -File | Select-Object -First 1
          
          if (-not $dacpacPath) {
            throw "DACPAC file not found in artifacts/database"
          }
          
          Write-Host "Deploying DACPAC: $($dacpacPath.FullName)"
          
          ./scripts/Deploy-Database.ps1 `
            -Server "${{ secrets.SQL_SERVER }}" `
            -Database "${{ secrets.SQL_DATABASE }}" `
            -AccessToken "${{ steps.get_token.outputs.token }}" `
            -DacpacPath $dacpacPath.FullName `
            -DependenciesPath "./dependencies" `
            -ScriptsPath "./scripts/sql"
        shell: pwsh

  scaffold-entities:
    name: Scaffold EF Core Entities
    runs-on: [self-hosted, windows, sql-server]
    needs: deploy-database
    environment: production
    
    env:
      SQL_SERVER: ${{ secrets.SQL_SERVER }}
      SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 10.0.0
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Get SQL Access Token
        id: get-token
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://database.windows.net --query accessToken -o tsv)
          echo "::add-mask::$token"
          "token=$token" >> $env:GITHUB_OUTPUT
      
      - name: Scaffold EF Core Entities
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $token = "${{ steps.get-token.outputs.token }}"
          
          Write-Host "Scaffolding EF Core entities from database schema..."
          
          $scriptPath = Join-Path $env:GITHUB_WORKSPACE "scripts\scaffold-entities.ps1"
          
          & $scriptPath `
            -SqlServer "${{ env.SQL_SERVER }}" `
            -Database "${{ env.SQL_DATABASE }}" `
            -UseAzureAD `
            -AccessToken $token
          
          Write-Host "‚úì EF Core entities scaffolded"
      
      - name: Commit scaffolded entities
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add src/Hartonomous.Data.Entities/**
          
          if (git diff --cached --quiet) {
            Write-Host "No changes to scaffolded entities"
          } else {
            git commit -m "chore: Update scaffolded EF Core entities from database schema"
            git push
            Write-Host "‚úì Scaffolded entities committed and pushed"
          }
      
      - name: Upload scaffolded entities
        uses: actions/upload-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
          retention-days: 1

  build-and-test:
    name: Build and Test .NET Solution
    runs-on: [self-hosted, linux]
    needs: scaffold-entities
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download scaffolded entities
        uses: actions/download-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Display .NET Info
        run: dotnet --info
      
      - name: Restore NuGet packages
        run: dotnet restore Hartonomous.Tests.sln --verbosity minimal
        shell: pwsh
      
      - name: Build solution
        run: |
          Write-Host "Building solution in ${{ env.BUILD_CONFIGURATION }} mode..."
          dotnet build Hartonomous.Tests.sln `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --no-restore `
            --verbosity minimal
        shell: pwsh
      
      - name: Run unit tests
        run: |
          Write-Host "Running unit tests..."
          dotnet test tests/**/*Tests.csproj `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --no-build `
            --collect:"XPlat Code Coverage" `
            --logger "trx;LogFileName=test-results.trx" `
            --results-directory ./TestResults `
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        shell: pwsh
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults/
          retention-days: 7
      
      - name: Build summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "`n=== Build Summary ==="
          
          $testResults = Get-ChildItem -Path "TestResults" -Filter "*.trx" -Recurse | Select-Object -First 1
          
          if ($testResults) {
            [xml]$trx = Get-Content $testResults.FullName
            $counters = $trx.TestRun.ResultSummary.Counters
            
            Write-Host "Tests Total: $($counters.total)"
            Write-Host "Tests Passed: $($counters.passed)"
            Write-Host "Tests Failed: $($counters.failed)"
            Write-Host "Tests Skipped: $($counters.notExecuted)"
            
            $summary = @"
          ## Test Results
          - ‚úÖ Passed: $($counters.passed)
          - ‚ùå Failed: $($counters.failed)
          - ‚è≠Ô∏è Skipped: $($counters.notExecuted)
          - üìä Total: $($counters.total)
          "@
            
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
          }

  build-applications:
    name: Build Applications
    runs-on: [self-hosted, linux]
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download scaffolded entities
        uses: actions/download-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore Hartonomous.Tests.sln
      
      - name: Publish Hartonomous.Api
        shell: pwsh
        run: |
          Write-Host "Publishing Hartonomous.Api..."
          
          $outputPath = Join-Path $env:GITHUB_WORKSPACE "artifacts\api"
          
          dotnet publish src/Hartonomous.Api/Hartonomous.Api.csproj `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --output $outputPath `
            --no-restore `
            /p:PublishSingleFile=false `
            /p:PublishTrimmed=false
          
          Write-Host "‚úì Hartonomous.Api published to: $outputPath"
      
      - name: Upload application artifacts
        uses: actions/upload-artifact@v4
        with:
          name: applications
          path: artifacts/
          retention-days: 7