name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      skip_tests:
        description: 'Skip validation tests'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read
  pull-requests: write
  checks: write

env:
  DOTNET_VERSION: '10.x'
  BUILD_CONFIGURATION: 'Release'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_NOLOGO: 'true'

jobs:
  # ============================================================================
  # STEP 1: Build DACPAC
  # ============================================================================
  build-dacpac:
    name: Build Database DACPAC
    runs-on: [self-hosted, windows, sql-server]  # Requires Windows for .NET Framework 4.8.1 CLR
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # MSBuild is already installed with Visual Studio - no need for .NET SDK
      
      - name: Build DACPACwith MSBuild
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          Write-Host "Building SQL Database Project..."
          $artifactDir = Join-Path $env:GITHUB_WORKSPACE "artifacts\database"
          New-Item -ItemType Directory -Path $artifactDir -Force | Out-Null
          
          $msbuildPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
          if (-not (Test-Path $msbuildPath)) {
            $msbuildPath = "C:\Program Files\Microsoft Visual Studio\18\Insiders\MSBuild\Current\Bin\MSBuild.exe"
          }
          
          $projectPath = Join-Path $env:GITHUB_WORKSPACE "src\Hartonomous.Database\Hartonomous.Database.sqlproj"
          
          & $msbuildPath $projectPath `
            /p:Configuration=Release `
            /p:OutputPath=$artifactDir `
            /t:Build `
            /v:minimal
          
          if ($LASTEXITCODE -ne 0) {
            throw "DACPAC build failed with exit code $LASTEXITCODE"
          }
          
          Write-Host "‚úì DACPAC built successfully"
      
      - name: Upload DACPAC artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-dacpac
          path: artifacts/database/
          retention-days: 7
      
      - name: Upload CLR dependencies
        uses: actions/upload-artifact@v4
        with:
          name: clr-dependencies
          path: dependencies/
          retention-days: 7
      
      - name: Upload deployment scripts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-scripts
          path: scripts/
          retention-days: 7

  # ============================================================================
  # STEP 2: Deploy Database (creates schema for scaffolding)
  # ============================================================================
  deploy-database:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: [self-hosted, windows, sql-server]
    needs: build-dacpac
    environment: ${{ inputs.environment || 'production' }}
    
    env:
      SQL_SERVER: ${{ secrets.SQL_SERVER }}
      SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download DACPAC
        uses: actions/download-artifact@v4
        with:
          name: database-dacpac
          path: ./artifacts/database
      
      - name: Download CLR dependencies
        uses: actions/download-artifact@v4
        with:
          name: clr-dependencies
          path: ./dependencies
      
      - name: Download deployment scripts
        uses: actions/download-artifact@v4
        with:
          name: deployment-scripts
          path: ./scripts

      - name: 'Login to Azure with OIDC'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: 'Get Azure AD Access Token for SQL'
        id: get_token
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://database.windows.net --query accessToken -o tsv)
          if (-not $token) {
            throw "Failed to retrieve Azure AD token for SQL Server."
          }
          echo "::add-mask::$token"
          echo "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: 'Step 2.1: Enable CLR & Configure Asymmetric Key Security'
        shell: pwsh
        run: |
          ./scripts/enable-clr.ps1 -Server "${{ env.SQL_SERVER }}" -UseAzureAD -AccessToken "${{ steps.get_token.outputs.token }}"

      - name: Step 2.2: Pre-DACPAC Cleanup (Idempotency)
        id: pre_dacpac_cleanup
        run: |
          $sqlScript = @"
          -- This script ensures idempotency by dropping all CLR-dependent objects
          -- before the DACPAC deployment. This prevents "object already exists" errors
          -- and handles dependency chains correctly.

          USE [${{ env.SQL_DATABASE }}];

          -- Drop all functions that depend on the main CLR assembly
          DECLARE @sql NVARCHAR(MAX) = N'';
          SELECT @sql += 'DROP FUNCTION ' + QUOTENAME(s.name) + '.' + QUOTENAME(o.name) + ';' + CHAR(13)
          FROM sys.assembly_modules am
          JOIN sys.assemblies a ON am.assembly_id = a.assembly_id
          JOIN sys.objects o ON am.object_id = o.object_id
          JOIN sys.schemas s ON o.schema_id = s.schema_id
          WHERE a.name = 'Hartonomous.Clr';
          EXEC sp_executesql @sql;
          PRINT 'Dropped all CLR-dependent functions.';

          -- Drop all aggregates that depend on the main CLR assembly
          SET @sql = N'';
          SELECT @sql += 'DROP AGGREGATE ' + QUOTENAME(s.name) + '.' + QUOTENAME(o.name) + ';' + CHAR(13)
          FROM sys.assembly_modules am
          JOIN sys.assemblies a ON am.assembly_id = a.assembly_id
          JOIN sys.objects o ON am.object_id = o.object_id
          JOIN sys.schemas s ON o.schema_id = s.schema_id
          WHERE a.name = 'Hartonomous.Clr' AND o.type = 'AF';
          EXEC sp_executesql @sql;
          PRINT 'Dropped all CLR-dependent aggregates.';

          -- Drop all types that depend on the main CLR assembly
          SET @sql = N'';
          SELECT @sql += 'DROP TYPE ' + QUOTENAME(s.name) + '.' + QUOTENAME(t.name) + ';' + CHAR(13)
          FROM sys.assembly_types at
          JOIN sys.assemblies a ON at.assembly_id = a.assembly_id
          JOIN sys.types t ON at.user_type_id = t.user_type_id
          JOIN sys.schemas s ON t.schema_id = s.schema_id
          WHERE a.name = 'Hartonomous.Clr';
          EXEC sp_executesql @sql;
          PRINT 'Dropped all CLR-dependent types.';

          -- Finally, drop the main CLR assembly itself
          IF EXISTS (SELECT 1 FROM sys.assemblies WHERE name = 'Hartonomous.Clr')
          BEGIN
              DROP ASSEMBLY [Hartonomous.Clr];
              PRINT 'Dropped Hartonomous.Clr assembly.';
          END
          "@
          Invoke-Sqlcmd -ServerInstance "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -Query $sqlScript -AccessToken "${{ steps.get_sql_token.outputs.token }}" -TrustServerCertificate
        shell: pwsh

      - name: Step 2.3: Deploy External (Unsigned) CLR Assemblies
        id: deploy_external_assemblies
        run: ./scripts/deploy-clr-assemblies.ps1 -Server "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -UseAzureAD -AccessToken "${{ steps.get_sql_token.outputs.token }}" -DependenciesPath ./dependencies
        shell: pwsh

      - name: 'Step 2.4: Deploy DACPAC (Hartonomous.Clr + T-SQL Objects)'
        shell: pwsh
        run: |
          $dacpacPath = "./artifacts/database/Hartonomous.Database.dacpac"
          $connectionString = "Server=${{ env.SQL_SERVER }};Database=${{ env.SQL_DATABASE }};Encrypt=True;TrustServerCertificate=True;"
          
          Write-Host "Deploying DACPAC: $dacpacPath"
          
          sqlpackage.exe /Action:Publish `
            /SourceFile:"$dacpacPath" `
            /TargetConnectionString:"$connectionString" `
            /AccessToken:"${{ steps.get_token.outputs.token }}" `
            /p:BlockOnPossibleDataLoss=False `
            /p:DropObjectsNotInSource=False
          
          if ($LASTEXITCODE -ne 0) {
            throw "DACPAC deployment failed with exit code $LASTEXITCODE"
          }
          Write-Host "‚úì DACPAC deployed successfully."

      - name: 'Step 2.5: Set TRUSTWORTHY ON (Required for Unsigned Assemblies)'
        shell: pwsh
        run: |
          ./scripts/set-trustworthy.ps1 -Server "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -UseAzureAD -AccessToken "${{ steps.get_token.outputs.token }}"
      
      - name: Validate Deployment
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $token = "${{ steps.get_token.outputs.token }}"
          
          Write-Host "`n=== Deployment Validation ==="
          
          # Count assemblies
          $count = Invoke-Sqlcmd -ServerInstance "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -Query "SELECT COUNT(*) as cnt FROM sys.assemblies WHERE is_user_defined = 1" -AccessToken $token -TrustServerCertificate
          Write-Host "External Assemblies: $($count.cnt)"
          
          # Count functions
          $count = Invoke-Sqlcmd -ServerInstance "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -Query "SELECT COUNT(*) as cnt FROM sys.objects WHERE type IN ('FN', 'IF', 'TF', 'FS', 'FT', 'AF', 'PC') AND is_ms_shipped = 0" -AccessToken $token -TrustServerCertificate
          Write-Host "User-Defined Functions/Procs/Aggregates: $($count.cnt)"
          
          # Count UDTs
          $count = Invoke-Sqlcmd -ServerInstance "${{ env.SQL_SERVER }}" -Database "${{ env.SQL_DATABASE }}" -Query "SELECT COUNT(*) as cnt FROM sys.types WHERE is_user_defined = 1 AND is_assembly_type = 1" -AccessToken $token -TrustServerCertificate
          Write-Host "CLR User-Defined Types: $($count.cnt)"
          
          Write-Host "`n‚úì Deployment validation complete"
      
      - name: Upload scaffolded entities artifact marker
        uses: actions/upload-artifact@v4
        with:
          name: database-deployed
          path: scripts/
          retention-days: 1

  # ============================================================================
  # STEP 3: Scaffold EF Core Entities (depends on deployed database)
  # ============================================================================
  scaffold-entities:
    name: Scaffold EF Core Entities
    runs-on: [self-hosted, windows, sql-server]  # Requires Windows for SQL Server access
    needs: deploy-database
    environment: ${{ inputs.environment || 'production' }}
    
    env:
      SQL_SERVER: ${{ secrets.SQL_SERVER }}
      SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 10.0.0
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Get SQL Access Token
        id: get-token
        shell: pwsh
        run: |
          $token = (az account get-access-token --resource https://database.windows.net --query accessToken -o tsv)
          echo "::add-mask::$token"
          "token=$token" >> $env:GITHUB_OUTPUT
      
      - name: Scaffold EF Core Entities
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $token = "${{ steps.get-token.outputs.token }}"
          
          Write-Host "Scaffolding EF Core entities from database schema..."
          
          $scriptPath = Join-Path $env:GITHUB_WORKSPACE "scripts\scaffold-entities.ps1"
          
          & $scriptPath `
            -SqlServer "${{ env.SQL_SERVER }}" `
            -Database "${{ env.SQL_DATABASE }}" `
            -UseAzureAD `
            -AccessToken $token
          
          Write-Host "‚úì EF Core entities scaffolded"
      
      - name: Commit scaffolded entities
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add src/Hartonomous.Data.Entities/**
          
          if (git diff --cached --quiet) {
            Write-Host "No changes to scaffolded entities"
          } else {
            git commit -m "chore: Update scaffolded EF Core entities from database schema"
            git push
            Write-Host "‚úì Scaffolded entities committed and pushed"
          }
      
      - name: Upload scaffolded entities
        uses: actions/upload-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
          retention-days: 1

  # ============================================================================
  # STEP 4: Build and Test .NET Solution (uses scaffolded entities)
  # ============================================================================
  build-and-test:
    name: Build and Test .NET Solution
    runs-on: [self-hosted, linux]  # .NET 10 is cross-platform, use Linux for speed
    needs: scaffold-entities
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download scaffolded entities
        uses: actions/download-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Display .NET Info
        run: dotnet --info
      
      - name: Restore NuGet packages
        run: dotnet restore Hartonomous.Tests.sln --verbosity minimal
        shell: pwsh
      
      - name: Build solution
        run: |
          Write-Host "Building solution in ${{ env.BUILD_CONFIGURATION }} mode..."
          dotnet build Hartonomous.Tests.sln `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --no-restore `
            --verbosity minimal
        shell: pwsh
      
      - name: Run unit tests
        run: |
          Write-Host "Running unit tests..."
          dotnet test tests/**/*Tests.csproj `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --no-build `
            --collect:"XPlat Code Coverage" `
            --logger "trx;LogFileName=test-results.trx" `
            --results-directory ./TestResults `
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        shell: pwsh
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults/
          retention-days: 7
      
      - name: Build summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "`n=== Build Summary ==="
          
          $testResults = Get-ChildItem -Path "TestResults" -Filter "*.trx" -Recurse | Select-Object -First 1
          
          if ($testResults) {
            [xml]$trx = Get-Content $testResults.FullName
            $counters = $trx.TestRun.ResultSummary.Counters
            
            Write-Host "Tests Total: $($counters.total)"
            Write-Host "Tests Passed: $($counters.passed)"
            Write-Host "Tests Failed: $($counters.failed)"
            Write-Host "Tests Skipped: $($counters.notExecuted)"
            
            $summary = @"
          ## Test Results
          - ‚úÖ Passed: $($counters.passed)
          - ‚ùå Failed: $($counters.failed)
          - ‚è≠Ô∏è Skipped: $($counters.notExecuted)
          - üìä Total: $($counters.total)
          "@
            
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
          }

  # ============================================================================
  # STEP 5: Build Applications (uses scaffolded entities)
  # ============================================================================
  build-applications:
    name: Build Applications
    runs-on: [self-hosted, linux]  # .NET 10 is cross-platform, use Linux for speed
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download scaffolded entities
        uses: actions/download-artifact@v4
        with:
          name: scaffolded-entities
          path: src/Hartonomous.Data.Entities/
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore Hartonomous.Tests.sln
      
      - name: Publish Hartonomous.Api
        shell: pwsh
        run: |
          Write-Host "Publishing Hartonomous.Api..."
          
          $outputPath = Join-Path $env:GITHUB_WORKSPACE "artifacts\api"
          
          dotnet publish src/Hartonomous.Api/Hartonomous.Api.csproj `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --output $outputPath `
            --no-restore `
            /p:PublishSingleFile=false `
            /p:PublishTrimmed=false
          
          Write-Host "‚úì Hartonomous.Api published to: $outputPath"
      
      - name: Upload application artifacts
        uses: actions/upload-artifact@v4
        with:
          name: applications
          path: artifacts/
          retention-days: 7
