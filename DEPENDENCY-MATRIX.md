# Hartonomous SQL CLR Assembly Dependency Matrix

**Analysis Date:** November 17, 2024  
**Target Framework:** .NET Framework 4.8.1  
**SQL Server Version:** SQL Server 2025 RC1 (17.0.925.4) Enterprise Developer Edition  
**CLR Permission Set:** UNSAFE

---

## Summary

| Category | Count |
|----------|-------|
| **Total Dependencies** | 14 assemblies |
| **Available in GAC** | 6 assemblies (should NOT deploy) |
| **Require Deployment** | 8 assemblies |
| **DACPAC-Generated** | 2 assemblies (Hartonomous.Database.dll, SqlClrFunctions.dll) |

---

## Dependency Matrix

### âœ… Assemblies to DEPLOY (Not in GAC)

| Assembly | Version | References | Notes |
|----------|---------|------------|-------|
| **System.Runtime.CompilerServices.Unsafe.dll** | 4.6.28619.01 | _(none)_ | **DEPLOY FIRST** - no dependencies |
| **System.Buffers.dll** | 4.6.28619.01 | _(none)_ | **DEPLOY SECOND** - no dependencies |
| **System.Numerics.Vectors.dll** | 4.6.26515.06 | System.Numerics (GAC) | **DEPLOY THIRD** - depends on GAC System.Numerics |
| **System.Memory.dll** | 4.6.28619.01 | System, System.Buffers, System.Numerics.Vectors, System.Runtime.CompilerServices.Unsafe | **DEPLOY FOURTH** - depends on above 3 |
| **System.Collections.Immutable.dll** | 4.700.20.21406 | System, System.Core, System.Memory | Requires System.Memory |
| **System.Reflection.Metadata.dll** | 4.700.20.21406 | System, System.Collections.Immutable, System.Core | Requires System.Collections.Immutable |
| **MathNet.Numerics.dll** | 5.0.0.0 | System, System.Core, System.Numerics (GAC), System.Runtime.Serialization (GAC) | Mathematical functions library |
| **Microsoft.SqlServer.Types.dll** | 16.0.1000.6 | System, System.Data, System.Xml | SQL Server spatial types (Geography, Geometry) |
| **Newtonsoft.Json.dll** | 13.0.1.25517 | System, System.Core, System.Data, System.Numerics (GAC), System.Runtime.Serialization (GAC), System.Xml | JSON serialization |

### âŒ Assemblies in GAC (DO NOT DEPLOY)

| Assembly | GAC Version | Our Version | Action |
|----------|-------------|-------------|--------|
| **System.Drawing.dll** | v4.0_4.0.0.0 | 4.8.9221.0 | **REMOVE** from dependencies folder |
| **System.Numerics** | v4.0_4.0.0.0 | _(not in deps)_ | Use from GAC |
| **System.Numerics.Vectors.dll** | v4.0_4.0.0.0 | 4.6.26515.06 | âš ï¸ **CONFLICT** - Deploy newer version? |
| **System.Runtime.Serialization.dll** | v4.0_4.0.0.0 | 4.8.9221.0 | **REMOVE** from dependencies folder |
| **System.ValueTuple.dll** | v4.0_4.0.0.0 | 4.6.26515.06 | **REMOVE** from dependencies folder |
| **SMDiagnostics.dll** | v4.0_4.0.0.0 | 4.8.9221.0 | **REMOVE** from dependencies folder |
| **System.ServiceModel.Internals.dll** | v4.0_4.0.0.0 | 4.8.9221.0 | **REMOVE** from dependencies folder |

### ğŸ—‘ï¸ Remove from Dependencies Folder

| Assembly | Reason |
|----------|--------|
| **Hartonomous.Database.dll** | Generated by DACPAC build process |
| **SqlClrFunctions.dll** | Generated by DACPAC build process |
| **System.Drawing.dll** | Available in GAC |
| **System.Runtime.Serialization.dll** | Available in GAC |
| **System.ValueTuple.dll** | Available in GAC (causes policy conflict) |
| **SMDiagnostics.dll** | Available in GAC |
| **System.ServiceModel.Internals.dll** | Available in GAC |

---

## Deployment Order (Based on Dependency Graph)

```
1. System.Runtime.CompilerServices.Unsafe.dll (no dependencies)
2. System.Buffers.dll (no dependencies)
3. System.Numerics.Vectors.dll (depends on GAC: System.Numerics)
4. System.Memory.dll (depends on: Unsafe, Buffers, Numerics.Vectors)
5. System.Collections.Immutable.dll (depends on: System.Memory)
6. System.Reflection.Metadata.dll (depends on: System.Collections.Immutable)
7. Microsoft.SqlServer.Types.dll (independent)
8. Newtonsoft.Json.dll (independent, uses GAC assemblies)
9. MathNet.Numerics.dll (independent, uses GAC assemblies)
```

---

## Full Dependency Tree

### MathNet.Numerics.dll
```
MathNet.Numerics.dll (5.0.0.0)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Core (GAC)
â”œâ”€â”€ System.Numerics (GAC) âœ…
â””â”€â”€ System.Runtime.Serialization (GAC) âœ…
```

### Microsoft.SqlServer.Types.dll
```
Microsoft.SqlServer.Types.dll (16.0.1000.6)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Data (GAC)
â””â”€â”€ System.Xml (GAC)
```

### Newtonsoft.Json.dll
```
Newtonsoft.Json.dll (13.0.1.25517)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Core (GAC)
â”œâ”€â”€ System.Data (GAC)
â”œâ”€â”€ System.Numerics (GAC) âœ…
â”œâ”€â”€ System.Runtime.Serialization (GAC) âœ…
â””â”€â”€ System.Xml (GAC)
```

### System.Memory.dll
```
System.Memory.dll (4.6.28619.01)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Buffers.dll âš™ï¸ DEPLOY
â”œâ”€â”€ System.Numerics.Vectors.dll âš™ï¸ DEPLOY
â””â”€â”€ System.Runtime.CompilerServices.Unsafe.dll âš™ï¸ DEPLOY
```

### System.Collections.Immutable.dll
```
System.Collections.Immutable.dll (4.700.20.21406)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Core (GAC)
â””â”€â”€ System.Memory.dll âš™ï¸ DEPLOY
```

### System.Reflection.Metadata.dll
```
System.Reflection.Metadata.dll (4.700.20.21406)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Collections.Immutable.dll âš™ï¸ DEPLOY
â””â”€â”€ System.Core (GAC)
```

### System.Numerics.Vectors.dll
```
System.Numerics.Vectors.dll (4.6.26515.06)
â””â”€â”€ System.Numerics (GAC) âœ…
```

### SMDiagnostics.dll (GAC - DO NOT DEPLOY)
```
SMDiagnostics.dll (4.8.9221.0)
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Configuration (GAC)
â”œâ”€â”€ System.ServiceModel.Internals (GAC) âœ…
â””â”€â”€ System.Xml (GAC)
```

### System.Runtime.Serialization.dll (GAC - DO NOT DEPLOY)
```
System.Runtime.Serialization.dll (4.8.9221.0)
â”œâ”€â”€ SMDiagnostics (GAC) âœ…
â”œâ”€â”€ System (GAC)
â”œâ”€â”€ System.Configuration (GAC)
â”œâ”€â”€ System.ServiceModel.Internals (GAC) âœ…
â””â”€â”€ System.Xml (GAC)
```

---

## .NET Framework 4.8.1 Compatibility

| Assembly | 4.8.1 Compatible | Notes |
|----------|------------------|-------|
| System.Runtime.CompilerServices.Unsafe | âœ… Yes | Part of .NET Standard 2.0 support |
| System.Buffers | âœ… Yes | Part of .NET Standard 2.0 support |
| System.Memory | âœ… Yes | Part of .NET Standard 2.0 support |
| System.Numerics.Vectors | âœ… Yes | Enhanced SIMD support in 4.8.1 |
| System.Collections.Immutable | âœ… Yes | Included in .NET Framework 4.8+ |
| System.Reflection.Metadata | âœ… Yes | Included in .NET Framework 4.8+ |
| MathNet.Numerics | âœ… Yes | Targets .NET Framework 4.6.1+ |
| Microsoft.SqlServer.Types | âœ… Yes | SQL Server 2019+ compatibility |
| Newtonsoft.Json | âœ… Yes | Version 13.x supports .NET Framework 4.5+ |

---

## GAC Version Conflicts

### System.Numerics.Vectors
- **GAC Version:** 4.0.0.0
- **Our Version:** 4.6.26515.06
- **Conflict Resolution:** Deploy our newer version to master database. SQL Server CLR will use deployed version over GAC for UNSAFE assemblies.

### System.ValueTuple (REMOVED)
- **GAC Version:** 4.0.0.0
- **Our Version:** 4.6.26515.06
- **Conflict Resolution:** âŒ **DO NOT DEPLOY** - causes "existing policy would keep it from being used" error. No assembly in our dependency tree directly references System.ValueTuple. Use GAC version.

---

## Action Items

1. âœ… **Remove from `dependencies/` folder:**
   - Hartonomous.Database.dll (DACPAC-generated)
   - SqlClrFunctions.dll (DACPAC-generated)
   - System.Drawing.dll (in GAC)
   - System.Runtime.Serialization.dll (in GAC)
   - System.ValueTuple.dll (in GAC, causes conflict)
   - SMDiagnostics.dll (in GAC)
   - System.ServiceModel.Internals.dll (in GAC)

2. âœ… **Update `Deploy-Database.ps1` deployment order:**
   ```powershell
   $deploymentOrder = @(
       "System.Runtime.CompilerServices.Unsafe.dll",
       "System.Buffers.dll",
       "System.Numerics.Vectors.dll",
       "System.Memory.dll",
       "System.Collections.Immutable.dll",
       "System.Reflection.Metadata.dll",
       "Microsoft.SqlServer.Types.dll",
       "Newtonsoft.Json.dll",
       "MathNet.Numerics.dll"
   )
   ```

3. âœ… **Deploy assemblies to `master` database with UNSAFE permission set**

4. âœ… **Deploy DACPAC to target database (Hartonomous/Hartonomous-Sandbox)**

---

## SQL Server 2025 CLR Notes

- **CLR Version:** CLR 4.0.30319.42000 (.NET Framework 4.8.1)
- **CLR Strict Security:** DISABLED on HART-SERVER
- **TRUSTWORTHY:** OFF (not required with Windows Authentication)
- **Assembly Deployment Target:** `master` database for shared external assemblies
- **Permission Set:** UNSAFE (all assemblies)
- **Signature Required:** No (CLR strict security disabled)
- **GAC Preference:** SQL Server loads from GAC if available, but deployed assemblies take precedence for UNSAFE permission set

---

## References

- [SQL Server CLR Integration](https://learn.microsoft.com/en-us/sql/relational-databases/clr-integration/common-language-runtime-integration-overview)
- [CLR Strict Security](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/clr-strict-security)
- [.NET Framework 4.8.1 Release Notes](https://learn.microsoft.com/en-us/dotnet/framework/whats-new/)
- [System.Memory on NuGet](https://www.nuget.org/packages/System.Memory/)
- [MathNet.Numerics Documentation](https://numerics.mathdotnet.com/)
