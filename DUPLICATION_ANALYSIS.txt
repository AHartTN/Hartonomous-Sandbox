HARTONOMOUS CODEBASE DUPLICATION ANALYSIS
==========================================

FINDINGS SUMMARY (5 patterns, ~1,370 duplicated lines):

1. SQL COMMAND EXECUTION - CRITICAL
   Files: 12 files, 23 occurrences
   Lines: ~460 duplicated
   Example: /src/Hartonomous.Api/Controllers/GenerationController.cs (line 48)
   Pattern: await using var connection = new SqlConnection() + command setup + reader parsing (repeated)
   Impact: Any SQL change requires 12+ file updates
   Solution: StoredProcedureInvoker helper class

2. ERROR HANDLING - CRITICAL  
   Files: 8 controllers, 26 try/catch blocks
   Lines: ~390 duplicated
   Pattern: Identical catch blocks (SqlException, validation, general Exception)
   Example: GenerationController, AutonomyController, BillingController (all identical)
   Impact: Changing error strategy requires 26 updates
   Solution: ControllerErrorHandler utility class

3. NULL VALIDATION - HIGH
   Files: 20+ files, mixed patterns
   Lines: ~60 duplicated
   Patterns: ArgumentNullException.ThrowIfNull() vs if (x == null) vs controller returns error
   Impact: Inconsistent API, confusing conventions
   Solution: Establish & enforce validation standard

4. EVENT HANDLERS - MEDIUM
   Files: 4 files, 97% duplication
   Lines: ~120 duplicated
   Example: ModelEventHandler, InferenceEventHandler, KnowledgeEventHandler identical
   Only difference: table name + method name
   Impact: 4 files for 2 variations
   Solution: ConfigurableEventHandler (delete 4 classes, replace with 1 generic)

5. VECTOR UTILITIES - MEDIUM
   Files: 6 SqlClr files
   Lines: ~300 duplicated
   Pattern: ParseVectorJson, null checks, similarity calculations (all 6 files)
   Impact: Bug fix requires 6 updates
   Solution: SqlClrVectorUtilities static class

DETAILED FINDINGS
=================

SQL COMMAND DUPLICATION:
Files: GenerationController, AutonomyController, BillingController, InferenceOrchestrator, 
        SpatialInferenceService, EmbeddingService, InferenceJobProcessor, SqlBillingUsageSink,
        AtomEmbeddingRepository, SearchController, OperationsController, TensorAtomTextGenerator

Count: 23 stored procedure calls with identical setup pattern
Pattern: 
  1. await using var connection = new SqlConnection(_connectionString);
  2. await connection.OpenAsync();
  3. await using var command = new SqlCommand(procName, connection)
  4. command.CommandType = CommandType.StoredProcedure;
  5. Multiple command.Parameters.AddWithValue() calls
  6. await using var reader = await command.ExecuteReaderAsync();
  7. Parse result set with reader.GetOrdinal(), reader.GetXxx()

Benefit of abstraction: Reduces ~20 lines per method to ~3-5 lines

ERROR HANDLING DUPLICATION:
Controllers with identical error blocks: 8
Methods affected: 26
Pattern found in: GenerationController, AutonomyController, BillingController, AnalyticsController,
                  SearchController, OperationsController, FeedbackController, ModelsController

Each block:
  - try: execute operation, return Ok(Success(result))
  - catch SqlException validation: log warning, return BadRequest with validation error
  - catch SqlException general: log error, return BadRequest with DB error
  - catch Exception: log error, return 500 with unknown error

Benefit: Replace 15 lines per method with 1 line using error handler

NULL VALIDATION INCONSISTENCY:
Patterns found:
  - ArgumentNullException.ThrowIfNull(value) - Modern approach
  - if (value == null) throw new ArgumentNullException() - Verbose approach  
  - if (request == null) return BadRequest() - Controller approach
  - Mixed with null coalescing operators

No single convention applied across codebase

EVENT HANDLER DUPLICATION:
4 handlers (ModelEventHandler, InferenceEventHandler, KnowledgeEventHandler, GenericEventHandler)
Each handler: ~30 lines
Identical code except:
  - Table name: "dbo.Models", "dbo.InferenceRequests", etc
  - Method: CreateModelNodeAsync, CreateInferenceNodeAsync, etc
  - Log text: "model", "inference", "knowledge", "generic"

VECTOR UTILITY DUPLICATION:
Found in: TimeSeriesVectorAggregates, RecommenderAggregates, ReasoningFrameworkAggregates,
          AdvancedVectorAggregates, NeuralVectorAggregates, GraphVectorAggregates

Duplicated code:
  - ParseVectorJson() - identical JSON parsing logic
  - Null check: if (vec == null) return; (50+ times)
  - Similarity calculations: cosine, euclidean, dot product
  - Vector normalization

REPOSITORY STATUS: GOOD (no action needed)
Base class EfRepository properly abstracts CRUD operations
15 repositories inherit without duplication

IMPLEMENTATION PLAN
===================

PHASE 1 (2 days) - CRITICAL:
- Create StoredProcedureInvoker class (saves 460 lines)
- Create ControllerErrorHandler class (saves 390 lines)
Result: 850 lines eliminated

PHASE 2 (1 day) - HIGH:
- Establish null validation convention
- Apply ValidationHelper across 20+ files
Result: Consistent patterns

PHASE 3 (1 day) - MEDIUM:
- Create ConfigurableEventHandler (saves 120 lines)
- Extract SqlClrVectorUtilities (saves 300 lines)
Result: 420 lines eliminated

TOTAL: ~1,370 lines saved, 4 days effort
