# Security Best Practices - Hartonomous

**Last Updated:** 2025-01-21

---

## ?? **Secrets Management Policy**

### **? ALLOWED in Source Control:**
- Configuration **templates** (no real values)
- Key Vault **references** (URIs to secrets, not the secrets themselves)
- Public API keys (Stripe publishable keys - client-safe)
- Documentation with **placeholder** values

### **? NEVER Commit:**
- Passwords (SQL SA, service accounts, etc.)
- API secret keys (Stripe, OpenAI, etc.)
- Private certificates (.pfx, .cer with private keys)
- Subscription IDs
- Tenant IDs
- IP addresses or server hostnames
- Connection strings with credentials
- Webhook signing secrets
- Personal access tokens

---

## ??? **Where Secrets Belong**

### **Local Development:**
```bash
# Use .NET user secrets (NOT appsettings.json)
cd src/Hartonomous.Api
dotnet user-secrets set "Stripe:SecretKey" "sk_test_..."
dotnet user-secrets set "ConnectionStrings:HartonomousDb" "Server=...;Password=..."

# User secrets location (gitignored by default):
# Windows: %APPDATA%\Microsoft\UserSecrets\<user_secrets_id>\secrets.json
# Linux: ~/.microsoft/usersecrets/<user_secrets_id>/secrets.json
```

### **Azure Production:**
```bash
# Store ALL secrets in Azure Key Vault
az keyvault secret set --vault-name kv-hartonomous \
  --name "Stripe-SecretKey" \
  --value "sk_live_..."

# Reference in App Configuration (NOT plain text)
az appconfig kv set --name appconfig-hartonomous \
  --key "Stripe:SecretKey" \
  --value '{"uri": "https://kv-hartonomous.vault.azure.net/secrets/Stripe-SecretKey"}'
```

### **CI/CD Pipelines:**
```yaml
# Use GitHub Secrets or Azure Pipeline Variables (encrypted)
# Never hardcode in YAML files

# GitHub Actions:
secrets.STRIPE_SECRET_KEY

# Azure Pipelines:
$(StripeSecretKey)  # Defined in pipeline variables (encrypted)
```

---

## ?? **Code Review Checklist**

Before committing, verify:

- [ ] No `appsettings.json` with real connection strings
- [ ] No passwords in any `.md` files
- [ ] No API keys in code comments
- [ ] All secrets use user-secrets or Key Vault
- [ ] `.gitignore` includes sensitive doc patterns
- [ ] No IP addresses or server names in docs
- [ ] Deployment guides are templates only

---

## ?? **If Secrets Were Committed**

### **Immediate Actions:**

1. **Revoke the compromised secret:**
   ```bash
   # Stripe keys
   stripe keys revoke sk_test_...
   
   # Azure service principals
   az ad sp credential reset --id <app-id>
   
   # SQL passwords
   sqlcmd -U sa -P "old" -Q "ALTER LOGIN sa WITH PASSWORD='new_strong_password'"
   ```

2. **Rotate credentials:**
   - Generate new API keys
   - Update Key Vault with new values
   - Update user secrets locally

3. **Clean Git history (if needed):**
   ```bash
   # Use git-filter-repo or BFG Repo-Cleaner
   # WARNING: Rewrites history, requires force push
   git filter-repo --path docs/deployment/ --invert-paths
   ```

4. **Notify team and audit access logs**

---

## ?? **Password Requirements**

### **SQL Server:**
- Minimum 8 characters
- Uppercase + lowercase + digit + special character
- Example: `D580ED0B6A!SQL2025` (but generate unique ones)

### **Azure Service Principals:**
- Auto-generated by Azure CLI
- Store in Key Vault immediately
- Rotate every 90 days

### **Stripe:**
- Test keys: `sk_test_...` and `pk_test_...`
- Live keys: `sk_live_...` and `pk_live_...`
- Webhook secrets: `whsec_...`
- Rotate after any compromise

---

## ?? **Audit Log Monitoring**

### **Enable Logging:**
```bash
# Azure Key Vault audit logs
az monitor diagnostic-settings create \
  --resource /subscriptions/.../vaults/kv-hartonomous \
  --name "KeyVaultAudit" \
  --logs '[{"category":"AuditEvent","enabled":true}]'

# SQL Server audit (on-prem via Arc)
sqlcmd -Q "CREATE SERVER AUDIT hartonomous_audit TO APPLICATION_LOG"
sqlcmd -Q "ALTER SERVER AUDIT hartonomous_audit WITH (STATE=ON)"
```

### **Alert on Suspicious Activity:**
- Failed authentication attempts (SQL, API)
- Key Vault secret access from unknown IPs
- Stripe webhook signature failures
- Unusual database access patterns

---

## ?? **References**

- [Azure Key Vault Best Practices](https://learn.microsoft.com/azure/key-vault/general/best-practices)
- [Safe Storage of App Secrets (.NET)](https://learn.microsoft.com/aspnet/core/security/app-secrets)
- [Stripe Security](https://stripe.com/docs/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Azure Security Baseline](https://learn.microsoft.com/security/benchmark/azure/)

---

## ? **Current Security Status**

### **Implemented:**
- ? User secrets for local development
- ? Azure Key Vault for production secrets
- ? App Configuration with Key Vault references
- ? `.gitignore` prevents sensitive file commits
- ? Managed identity for Azure resources
- ? SQL injection prevention (parameterized queries)
- ? HTTPS enforcement
- ? Stripe webhook signature verification

### **To Do:**
- ? Implement secret rotation policy (90-day cadence)
- ? Set up Key Vault audit log alerts
- ? Configure Entra Conditional Access policies
- ? Enable MFA for all admin accounts
- ? Regular penetration testing
- ? Vulnerability scanning in CI/CD

---

**Contact Security Team:** security@hartonomous.com (when established)
