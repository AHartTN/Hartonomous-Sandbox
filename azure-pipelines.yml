# ============================================================================
# Hartonomous Azure DevOps Pipeline
# Complete CI/CD for SQL Server Database + CLR + .NET 10 Applications
# Based on Microsoft Docs 2024/2025 Official Guidance
# ============================================================================

name: Hartonomous-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - docs/**
      - '*.md'
      - LICENSE

pool:
  name: 'Local Agent Pool'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetSdkVersion
    value: '10.x'
  - name: sqlServer
    value: 'localhost'
  - name: sqlDatabase
    value: 'Hartonomous'

stages:
# ============================================================================
# STAGE 1: BUILD DATABASE DACPAC ONLY
# ============================================================================
- stage: BuildDatabase
  displayName: 'Build Database DACPAC'
  jobs:
  - job: BuildDACPAC
    displayName: 'Build Database DACPAC'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
        performMultiLevelLookup: true
    
    # Build DACPAC using msbuild (agent must have MSBuild or Visual Studio)
    - task: PowerShell@2
      displayName: 'Build SQL Database Project with MSBuild'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          
          # Find MSBuild
          $msbuild = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
            -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe `
            -prerelease | Select-Object -First 1
          
          if (-not $msbuild) {
            $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
          }
          
          if (-not (Test-Path $msbuild)) {
            Write-Error "MSBuild not found. Agent needs Visual Studio or MSBuild installed."
            exit 1
          }
          
          Write-Host "Using MSBuild: $msbuild"
          
          # Build DACPAC
          & $msbuild src/Hartonomous.Database/Hartonomous.Database.sqlproj `
            /p:Configuration=$(buildConfiguration) `
            /p:OutDir="$(Build.ArtifactStagingDirectory)/database/" `
            /v:minimal
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "✓ DACPAC built successfully"
        pwsh: true
        
    # Verify DACPAC
    - task: PowerShell@2
      displayName: 'Verify DACPAC Build'
      inputs:
        targetType: 'inline'
        script: |
          $dacpacPath = "$(Build.ArtifactStagingDirectory)/database/Hartonomous.Database.dacpac"
          if (Test-Path $dacpacPath) {
            Write-Host "✓ DACPAC built successfully: $dacpacPath"
            $hash = (Get-FileHash $dacpacPath -Algorithm SHA256).Hash
            Write-Host "SHA256: $hash"
          } else {
            Write-Error "✗ DACPAC not found at $dacpacPath"
            exit 1
          }
        pwsh: true

    # Copy external CLR dependencies
    - task: CopyFiles@2
      displayName: 'Copy External CLR Dependencies'
      inputs:
        SourceFolder: 'dependencies'
        Contents: '*.dll'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/dependencies'

    # Publish database artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Database Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/database'
        artifact: 'database'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 2: DEPLOY DATABASE (DACPAC + EXTERNAL CLR)
# ============================================================================
- stage: DeployDatabase
  displayName: 'Deploy Database Schema'
  dependsOn: BuildDatabase
  condition: succeeded()
  jobs:
  - deployment: DatabaseDeployment
    displayName: 'Deploy to SQL Server'
    pool:
      name: 'Local Agent Pool'
    environment: 'SQL-Server-Production'
    strategy:
      runOnce:
        deploy:
          steps:
          # Download database artifact
          - download: current
            artifact: database

          # Step 0: Grant Pipeline Agent Permissions (Idempotent)
          - task: PowerShell@2
            displayName: 'Grant Agent Permissions'
            inputs:
              targetType: 'inline'
              script: |
                if (-not (Get-Module -ListAvailable -Name SqlServer)) {
                  Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
                }
                $sql = @"
USE [master];
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'clr enabled', 1; RECONFIGURE;
EXEC sp_configure 'clr strict security', 0; RECONFIGURE;
PRINT 'CLR integration enabled';
"@
                Invoke-Sqlcmd -Query $sql -ServerInstance "$(sqlServer)" -TrustServerCertificate
                Write-Host "✓ Agent permissions granted"
              pwsh: true

          # Step 1: Enable CLR Integration (Idempotent)
          - task: PowerShell@2
            displayName: 'Enable CLR Integration'
            inputs:
              targetType: 'inline'
              script: |
                if (-not (Get-Module -ListAvailable -Name SqlServer)) {
                  Install-Module -Name SqlServer -Force -AllowClobber -Scope CurrentUser
                }
                $sql = @"
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'clr enabled', 1; RECONFIGURE;
EXEC sp_configure 'clr strict security', 0; RECONFIGURE;
PRINT 'CLR integration enabled successfully';
"@
                Invoke-Sqlcmd -Query $sql -ServerInstance "$(sqlServer)" -Database "master" -TrustServerCertificate
                Write-Host "✓ CLR enabled"
              pwsh: true

          # Step 2: Deploy External CLR Assemblies (Idempotent with proper error handling)
          - task: PowerShell@2
            displayName: 'Deploy External CLR Assemblies'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Continue'
                $dependenciesPath = "$(Pipeline.Workspace)/database/dependencies"
                $server = "$(sqlServer)"
                $database = "$(sqlDatabase)"
                
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Deploying 13 External CLR Assemblies" -ForegroundColor Cyan
                Write-Host "(Application assemblies deployed by DACPAC)" -ForegroundColor Gray
                Write-Host "========================================" -ForegroundColor Cyan
                
                $script:criticalFailures = @()
                $script:warnings = @()
                $script:successes = 0
                
                function Deploy-ClrAssembly {
                    param(
                        [string]$Name,
                        [string]$FilePath,
                        [switch]$Critical
                    )
                    
                    Write-Host "`n[$Name]" -ForegroundColor White
                    
                    # Check file exists
                    if (-not (Test-Path $FilePath)) {
                        $msg = "File not found: $FilePath"
                        Write-Warning "  ✗ $msg"
                        if ($Critical) { $script:criticalFailures += "$Name - $msg" }
                        else { $script:warnings += "$Name - $msg" }
                        return $false
                    }
                    
                    # Check if already registered with correct version
                    $checkExisting = "SELECT clr_name FROM sys.assemblies WHERE name = '$Name'"
                    $existing = sqlcmd -S $server -d $database -E -C -Q $checkExisting -h -1 2>&1 | Select-Object -First 1
                    
                    $fileHash = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash
                    Write-Host "  File: $FilePath"
                    Write-Host "  Hash: $fileHash"
                    
                    if ($existing -and $existing -notmatch "^\s*$") {
                        Write-Host "  Existing: $($existing.Trim())"
                        Write-Host "  Updating..." -ForegroundColor Yellow
                    } else {
                        Write-Host "  Creating new..." -ForegroundColor Green
                    }
                    
                    # Convert to hex
                    $bytes = [System.IO.File]::ReadAllBytes($FilePath)
                    $hex = ($bytes | ForEach-Object { $_.ToString("X2") }) -join ''
                    
                    # Generate SQL
                    $tempFile = [System.IO.Path]::GetTempFileName() + ".sql"
                    $sql = @"
USE [master];
IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = '$database')
BEGIN
    CREATE DATABASE [$database];
END
GO
USE [$database];
GO
IF EXISTS (SELECT * FROM sys.assemblies WHERE name = '$Name')
    DROP ASSEMBLY [$Name];
GO
CREATE ASSEMBLY [$Name] FROM 0x$hex WITH PERMISSION_SET = UNSAFE;
GO
"@
                    $sql | Out-File -FilePath $tempFile -Encoding utf8
                    
                    try {
                        # Execute without -b flag (warnings don't fail)
                        $output = sqlcmd -S $server -d master -E -C -i $tempFile 2>&1
                        
                        # Parse output for Level 16+ errors (not warnings)
                        $errors = $output | Where-Object { $_ -match "^Msg \d+, Level (1[6-9]|2[0-5])" }
                        
                        # Verify registration
                        $verifyCount = sqlcmd -S $server -d $database -E -C -Q "SELECT COUNT(*) FROM sys.assemblies WHERE name = '$Name'" -h -1 2>&1 | Select-Object -First 1
                        
                        if ($verifyCount -match "^\s*1\s*$") {
                            Write-Host "  ✓ Successfully deployed and verified" -ForegroundColor Green
                            $script:successes++
                            return $true
                        } else {
                            $msg = "Assembly not found after deployment"
                            if ($errors) {
                                $errorMsg = ($errors | Select-Object -First 3) -join "`n    "
                                $msg += ": $errorMsg"
                            }
                            Write-Warning "  ✗ $msg"
                            if ($Critical) { $script:criticalFailures += "$Name - $msg" }
                            else { $script:warnings += "$Name - $msg" }
                            return $false
                        }
                    } finally {
                        Remove-Item $tempFile -ErrorAction SilentlyContinue
                    }
                }
                
                Write-Host "\nTier 1: Base Runtime Dependencies" -ForegroundColor Cyan
                Deploy-ClrAssembly 'System.Numerics.Vectors' "$dependenciesPath/System.Numerics.Vectors.dll" -Critical
                # System.ValueTuple skipped - conflicts with SQL Server built-in type
                
                Write-Host "`nTier 2: Memory Management" -ForegroundColor Cyan
                Deploy-ClrAssembly 'System.Memory' "$dependenciesPath/System.Memory.dll"
                Deploy-ClrAssembly 'System.Buffers' "$dependenciesPath/System.Buffers.dll"
                Deploy-ClrAssembly 'System.Runtime.CompilerServices.Unsafe' "$dependenciesPath/System.Runtime.CompilerServices.Unsafe.dll"
                
                Write-Host "`nTier 3: Collections and Reflection" -ForegroundColor Cyan
                Deploy-ClrAssembly 'System.Collections.Immutable' "$dependenciesPath/System.Collections.Immutable.dll"
                Deploy-ClrAssembly 'System.Reflection.Metadata' "$dependenciesPath/System.Reflection.Metadata.dll"
                
                Write-Host "`nTier 4: Serialization" -ForegroundColor Cyan
                Deploy-ClrAssembly 'System.Runtime.Serialization' "$dependenciesPath/System.Runtime.Serialization.dll"
                Deploy-ClrAssembly 'System.ServiceModel.Internals' "$dependenciesPath/System.ServiceModel.Internals.dll"
                Deploy-ClrAssembly 'SMDiagnostics' "$dependenciesPath/SMDiagnostics.dll"
                
                Write-Host "`nTier 5: Third-party Libraries" -ForegroundColor Cyan
                Deploy-ClrAssembly 'MathNet.Numerics' "$dependenciesPath/MathNet.Numerics.dll"
                Deploy-ClrAssembly 'Newtonsoft.Json' "$dependenciesPath/Newtonsoft.Json.dll"
                Deploy-ClrAssembly 'Microsoft.SqlServer.Types' "$dependenciesPath/Microsoft.SqlServer.Types.dll"
                
                Write-Host "\nTier 6: Application Assemblies" -ForegroundColor Cyan
                Deploy-ClrAssembly 'System.Drawing' "$dependenciesPath/System.Drawing.dll" -Critical
                # SqlClrFunctions and Hartonomous.Database are deployed by DACPAC post-deployment scripts
                # NOT deployed here to avoid version conflicts
                
                # Summary
                Write-Host "`n========================================" -ForegroundColor Cyan
                Write-Host "Deployment Summary" -ForegroundColor Cyan
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "✓ Successful: $($script:successes)" -ForegroundColor Green
                Write-Host "⚠ Warnings: $($script:warnings.Count)" -ForegroundColor Yellow
                Write-Host "✗ Critical Failures: $($script:criticalFailures.Count)" -ForegroundColor Red
                
                if ($script:warnings.Count -gt 0) {
                    Write-Host "`nWarnings (non-critical):" -ForegroundColor Yellow
                    $script:warnings | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
                }
                
                if ($script:criticalFailures.Count -gt 0) {
                    Write-Host "`nCritical Failures:" -ForegroundColor Red
                    $script:criticalFailures | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
                    Write-Error "Critical assemblies failed to deploy"
                    exit 1
                }
                
                Write-Host "`n✓ CLR assembly deployment completed successfully" -ForegroundColor Green
                exit 0
              pwsh: true

          # Step 3: Deploy DACPAC (includes Hartonomous.Clr.dll)
          - task: PowerShell@2
            displayName: 'Deploy DACPAC with Hartonomous.Clr Assembly'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                $dacpacPath = "$(Pipeline.Workspace)/database/Hartonomous.Database.dacpac"
                $connectionString = "Server=$(sqlServer);Database=$(sqlDatabase);Integrated Security=True;TrustServerCertificate=True;"
                
                Write-Host "Deploying DACPAC: $dacpacPath"
                Write-Host "This DACPAC includes Hartonomous.Clr.dll assembly embedded as hex binary"
                
                sqlpackage.exe `
                  /Action:Publish `
                  /SourceFile:"$dacpacPath" `
                  /TargetConnectionString:"$connectionString" `
                  /p:DropObjectsNotInSource=False `
                  /p:BlockOnPossibleDataLoss=True `
                  /p:IgnorePreDeployScript=True `
                  /p:IgnorePostDeployScript=True
                
                if ($LASTEXITCODE -ne 0) { throw "DACPAC deployment failed" }
                Write-Host "✓ DACPAC deployed with Hartonomous.Clr assembly"
              pwsh: true

          # Step 4: Set TRUSTWORTHY ON (Idempotent)
          - task: PowerShell@2
            displayName: 'Set TRUSTWORTHY ON'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                $dbName = '$(sqlDatabase)'
                $sql = "USE master; ALTER DATABASE [$dbName] SET TRUSTWORTHY ON; PRINT 'TRUSTWORTHY enabled for $dbName';"
                $tempFile = [System.IO.Path]::GetTempFileName() + ".sql"
                try {
                  $sql | Out-File -FilePath $tempFile -Encoding utf8
                  sqlcmd -S "$(sqlServer)" -d "master" -E -C -i $tempFile -b
                  if ($LASTEXITCODE -ne 0) { throw "Failed to set TRUSTWORTHY" }
                  Write-Host "✓ TRUSTWORTHY validated"
                } finally {
                  Remove-Item $tempFile -ErrorAction SilentlyContinue
                }
              pwsh: true

# ============================================================================
# STAGE 3: SCAFFOLD EF CORE ENTITIES
# ============================================================================
- stage: ScaffoldEntities
  displayName: 'Scaffold EF Core Entities'
  dependsOn: DeployDatabase
  condition: succeeded()
  jobs:
  - job: Scaffold
    displayName: 'Generate Entity Classes from DB'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
    
    # Scaffold entities from deployed database
    - task: PowerShell@2
      displayName: 'Scaffold EF Core Entities'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          
          Write-Host "Scaffolding entities from database..."
          
          cd src/Hartonomous.Data.Entities
          
          dotnet ef dbcontext scaffold `
            "Server=$(sqlServer);Database=$(sqlDatabase);Integrated Security=True;TrustServerCertificate=True;" `
            Microsoft.EntityFrameworkCore.SqlServer `
            --output-dir Entities `
            --context-dir . `
            --context HartonomousDbContext `
            --force `
            --no-build
          
          Write-Host "\u2713 Entities scaffolded"
        pwsh: true

# ============================================================================
# STAGE 4: BUILD .NET SOLUTION
# ============================================================================
- stage: BuildDotNet
  displayName: 'Build .NET Solution'
  dependsOn: ScaffoldEntities
  condition: succeeded()
  jobs:
  - job: BuildDotNetJob
    displayName: 'Build .NET Solution + CLR'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'

    # Restore NuGet packages
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: 'Hartonomous.sln'
        feedsToUse: 'select'

    # Build solution
    - task: DotNetCoreCLI@2
      displayName: 'Build Solution (Release)'
      inputs:
        command: 'build'
        projects: 'Hartonomous.sln'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # Run unit tests
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      inputs:
        command: 'test'
        projects: 'tests/**/*Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx'
        publishTestResults: true

    # Publish applications
    - task: DotNetCoreCLI@2
      displayName: 'Publish Hartonomous.Api'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Api/Hartonomous.Api.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/api'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish CesConsumer'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.CesConsumer/Hartonomous.Workers.CesConsumer.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/ces-consumer'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish Neo4jSync'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.Neo4jSync/Hartonomous.Workers.Neo4jSync.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/neo4j-sync'
        zipAfterPublish: false

    # Copy deployment scripts
    - task: CopyFiles@2
      displayName: 'Copy Deployment Scripts'
      inputs:
        SourceFolder: 'scripts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/scripts'

    # Copy procedure files
    - task: CopyFiles@2
      displayName: 'Copy Stored Procedures'
      inputs:
        SourceFolder: 'src/Hartonomous.Database/Procedures'
        Contents: '**/*.sql'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/Procedures'

    # Publish .NET artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish .NET Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'dotnet'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 5: DEPLOY APPLICATIONS (Optional)
# ============================================================================
- stage: DeployApplications
  displayName: 'Deploy .NET Applications'
  dependsOn: BuildDotNet
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: AppDeployment
    displayName: 'Deploy Applications'
    pool:
      vmImage: 'windows-latest'
    environment: 'Application-Servers'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: dotnet

          - task: PowerShell@2
            displayName: 'Display Deployment Summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================"
                Write-Host "  Hartonomous Deployment Complete"
                Write-Host "========================================"
                Write-Host "Database: $(sqlServer)\$(sqlDatabase)"
                Write-Host ""
                Write-Host "Artifacts Ready for Deployment:"
                Write-Host "  - API: $(Pipeline.Workspace)/dotnet/api"
                Write-Host "  - CesConsumer: $(Pipeline.Workspace)/dotnet/ces-consumer"
                Write-Host "  - Neo4jSync: $(Pipeline.Workspace)/dotnet/neo4j-sync"
                Write-Host ""
                Write-Host "Next Steps:"
                Write-Host "  1. Configure service connections"
                Write-Host "  2. Deploy to target servers"
                Write-Host "  3. Configure application settings"
                Write-Host "  4. Run smoke tests"
                Write-Host "========================================"
              pwsh: true
