# ============================================================================
# Hartonomous Azure DevOps Pipeline
# Complete CI/CD for SQL Server Database + CLR + .NET 10 Applications
# Based on Microsoft Docs 2024/2025 Official Guidance
# ============================================================================

name: Hartonomous-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - docs/**
      - '*.md'
      - LICENSE

pool:
  name: 'Local Agent Pool'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetSdkVersion
    value: '10.x'
  - name: sqlServer
    value: 'localhost'
  - name: sqlDatabase
    value: 'Hartonomous'

stages:
# ============================================================================
# STAGE 1: BUILD DATABASE DACPAC ONLY
# ============================================================================
- stage: BuildDatabase
  displayName: 'Build Database DACPAC'
  jobs:
  - job: BuildDACPAC
    displayName: 'Build Database DACPAC'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
        includePreviewVersions: true
        performMultiLevelLookup: true
    
    # Build DACPAC using msbuild (agent must have MSBuild or Visual Studio)
    - task: PowerShell@2
      displayName: 'Build SQL Database Project with MSBuild'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          
          # Find MSBuild
          $msbuild = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
            -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe `
            -prerelease | Select-Object -First 1
          
          if (-not $msbuild) {
            $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
          }
          
          if (-not (Test-Path $msbuild)) {
            Write-Error "MSBuild not found. Agent needs Visual Studio or MSBuild installed."
            exit 1
          }
          
          Write-Host "Using MSBuild: $msbuild"
          
          # Build DACPAC
          & $msbuild src/Hartonomous.Database/Hartonomous.Database.sqlproj `
            /p:Configuration=$(buildConfiguration) `
            /p:OutDir="$(Build.ArtifactStagingDirectory)/database/" `
            /v:minimal
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "✓ DACPAC built successfully"
        pwsh: true
        
    # Verify DACPAC
    - task: PowerShell@2
      displayName: 'Verify DACPAC Build'
      inputs:
        targetType: 'inline'
        script: |
          $dacpacPath = "$(Build.ArtifactStagingDirectory)/database/Hartonomous.Database.dacpac"
          if (Test-Path $dacpacPath) {
            Write-Host "✓ DACPAC built successfully: $dacpacPath"
            $hash = (Get-FileHash $dacpacPath -Algorithm SHA256).Hash
            Write-Host "SHA256: $hash"
          } else {
            Write-Error "✗ DACPAC not found at $dacpacPath"
            exit 1
          }
        pwsh: true

    # Copy external CLR dependencies
    - task: CopyFiles@2
      displayName: 'Copy External CLR Dependencies'
      inputs:
        SourceFolder: 'dependencies'
        Contents: '*.dll'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/dependencies'

    # Publish database artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Database Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/database'
        artifact: 'database'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 2: DEPLOY DATABASE (DACPAC + EXTERNAL CLR)
# ============================================================================
- stage: DeployDatabase
  displayName: 'Deploy Database Schema'
  dependsOn: BuildDatabase
  condition: succeeded()
  jobs:
  - deployment: DatabaseDeployment
    displayName: 'Deploy to SQL Server'
    pool:
      name: 'Local Agent Pool'
    environment: 'SQL-Server-Production'
    strategy:
      runOnce:
        deploy:
          steps:
          # Download database artifact
          - download: current
            artifact: database

          # Step 0: Grant Pipeline Agent Permissions (Idempotent)
          - script: sqlcmd -S "$(sqlServer)" -d master -E -C -i "scripts/sql/grant-pipeline-permissions.sql" -b
            displayName: 'Grant Agent Permissions'

          # Step 1: Enable CLR Integration (Idempotent)
          - script: sqlcmd -S "$(sqlServer)" -d master -E -C -i "scripts/sql/enable-clr.sql" -b
            displayName: 'Enable CLR Integration'

          # Step 2: Set TRUSTWORTHY ON (Required BEFORE deploying UNSAFE assemblies)
          - script: sqlcmd -S "$(sqlServer)" -d master -E -C -Q "ALTER DATABASE [$(sqlDatabase)] SET TRUSTWORTHY ON" -b
            displayName: 'Set TRUSTWORTHY ON'

          # Step 3: Deploy External CLR Assemblies (16 assemblies in dependency order - Idempotent)
          - task: PowerShell@2
            displayName: 'Deploy External CLR Assemblies'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                $dependenciesPath = "$(Pipeline.Workspace)/database/dependencies"
                $server = "$(sqlServer)"
                $database = "$(sqlDatabase)"
                
                Write-Host "Deploying 16 external CLR assemblies (idempotent)..."
                
                function Deploy-ClrAssembly {
                    param([string]$Name, [string]$FilePath)
                    Write-Host "  Checking: $Name"
                    
                    if (-not (Test-Path $FilePath)) {
                        throw "Assembly file not found: $FilePath"
                    }
                    
                    $bytes = [System.IO.File]::ReadAllBytes($FilePath)
                    $hex = ($bytes | ForEach-Object { $_.ToString("X2") }) -join ''
                    $fileHash = (Get-FileHash -Path $FilePath -Algorithm SHA256).Hash
                    
                    $tempFile = [System.IO.Path]::GetTempFileName() + ".sql"
                    
                    $sql = "USE [master];`n"
                    $sql += "GO`n"
                    $sql += "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = '$database')`n"
                    $sql += "BEGIN`n"
                    $sql += "    CREATE DATABASE [$database];`n"
                    $sql += "    PRINT 'Database [$database] created';`n"
                    $sql += "END`n"
                    $sql += "GO`n"
                    $sql += "USE [$database];`n"
                    $sql += "GO`n"
                    $sql += "IF EXISTS (SELECT * FROM sys.assemblies WHERE name = '$Name')`n"
                    $sql += "BEGIN`n"
                    $sql += "    PRINT '  Assembly exists, updating...';`n"
                    $sql += "    DROP ASSEMBLY [$Name];`n"
                    $sql += "END`n"
                    $sql += "ELSE`n"
                    $sql += "BEGIN`n"
                    $sql += "    PRINT '  Assembly not found, creating...';`n"
                    $sql += "END`n"
                    # Most system assemblies should use SAFE permission set, not UNSAFE
                    $permissionSet = if ($Name -in @('System.Numerics.Vectors', 'System.ValueTuple', 'System.Memory', 'System.Buffers', 'System.Runtime.CompilerServices.Unsafe', 'System.Collections.Immutable', 'System.Reflection.Metadata')) { 'SAFE' } else { 'UNSAFE' }
                    $sql += "CREATE ASSEMBLY [$Name] FROM 0x$hex WITH PERMISSION_SET = $permissionSet;`n"
                    $sql += "PRINT '  OK $Name deployed (SHA256: $fileHash)';`n"
                    $sql += "GO`n"

                    $sql | Out-File -FilePath $tempFile -Encoding utf8

                    try {
                        sqlcmd -S $server -d master -E -C -i $tempFile -b
                        if ($LASTEXITCODE -ne 0) {
                            Write-Host "  ⚠ $Name deployment failed - skipping (may not be required)" -ForegroundColor Yellow
                        } else {
                            Write-Host "  ✓ $Name deployed"
                        }
                    } finally {
                        Remove-Item $tempFile -ErrorAction SilentlyContinue
                    }
                }
                
                # Tier 1: Base runtime dependencies
                Deploy-ClrAssembly 'System.Numerics.Vectors' "$dependenciesPath/System.Numerics.Vectors.dll"
                Deploy-ClrAssembly 'System.ValueTuple' "$dependenciesPath/System.ValueTuple.dll"
                
                # Tier 2: Memory management
                Deploy-ClrAssembly 'System.Memory' "$dependenciesPath/System.Memory.dll"
                Deploy-ClrAssembly 'System.Buffers' "$dependenciesPath/System.Buffers.dll"
                Deploy-ClrAssembly 'System.Runtime.CompilerServices.Unsafe' "$dependenciesPath/System.Runtime.CompilerServices.Unsafe.dll"
                
                # Tier 3: Collections and reflection
                Deploy-ClrAssembly 'System.Collections.Immutable' "$dependenciesPath/System.Collections.Immutable.dll"
                Deploy-ClrAssembly 'System.Reflection.Metadata' "$dependenciesPath/System.Reflection.Metadata.dll"
                
                # Tier 4: Serialization
                Deploy-ClrAssembly 'System.Runtime.Serialization' "$dependenciesPath/System.Runtime.Serialization.dll"
                Deploy-ClrAssembly 'System.ServiceModel.Internals' "$dependenciesPath/System.ServiceModel.Internals.dll"
                Deploy-ClrAssembly 'SMDiagnostics' "$dependenciesPath/SMDiagnostics.dll"
                
                # Tier 5: Third-party libraries
                Deploy-ClrAssembly 'MathNet.Numerics' "$dependenciesPath/MathNet.Numerics.dll"
                Deploy-ClrAssembly 'Newtonsoft.Json' "$dependenciesPath/Newtonsoft.Json.dll"
                Deploy-ClrAssembly 'Microsoft.SqlServer.Types' "$dependenciesPath/Microsoft.SqlServer.Types.dll"
                
                # Tier 6: Application assemblies
                Deploy-ClrAssembly 'System.Drawing' "$dependenciesPath/System.Drawing.dll"
                Deploy-ClrAssembly 'SqlClrFunctions' "$dependenciesPath/SqlClrFunctions.dll"
                Deploy-ClrAssembly 'Hartonomous.Database' "$dependenciesPath/Hartonomous.Database.dll"
                
                Write-Host "✓ All 16 external CLR assemblies deployed successfully"
              pwsh: true

          # Step 3: Deploy DACPAC (includes Hartonomous.Clr.dll)
          - task: PowerShell@2
            displayName: 'Deploy DACPAC with Hartonomous.Clr Assembly'
            inputs:
              targetType: 'inline'
              script: |
                sqlpackage /Action:Publish `
                  /SourceFile:"$(Pipeline.Workspace)/database/Hartonomous.Database.dacpac" `
                  /TargetServerName:"$(sqlServer)" `
                  /TargetDatabaseName:"$(sqlDatabase)" `
                  /TargetTrustServerCertificate:True `
                  /p:DropObjectsNotInSource=False `
                  /p:BlockOnPossibleDataLoss=True
              pwsh: true

# ============================================================================
# STAGE 3: SCAFFOLD EF CORE ENTITIES
# ============================================================================
- stage: ScaffoldEntities
  displayName: 'Scaffold EF Core Entities'
  dependsOn: DeployDatabase
  condition: succeeded()
  jobs:
  - job: Scaffold
    displayName: 'Generate Entity Classes from DB'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
        includePreviewVersions: true
        performMultiLevelLookup: true

    # Install dotnet-ef tool
    - task: PowerShell@2
      displayName: 'Install dotnet-ef Tool'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Continue'
          dotnet tool install --global dotnet-ef --version 10.0.0 2>$null
          if ($LASTEXITCODE -ne 0) {
            dotnet tool update --global dotnet-ef --version 10.0.0
          }
          dotnet ef --version
        pwsh: true

    # Build Data.Entities project
    - task: PowerShell@2
      displayName: 'Build Data.Entities Project'
      inputs:
        targetType: 'inline'
        script: |
          dotnet build src/Hartonomous.Data.Entities/Hartonomous.Data.Entities.csproj --configuration Release
        pwsh: true

    # Scaffold entities from deployed database
    - task: PowerShell@2
      displayName: 'Scaffold EF Core Entities'
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          
          Write-Host "Scaffolding entities from database..."
          
          cd src/Hartonomous.Data.Entities
          
          dotnet ef dbcontext scaffold `
            "Server=$(sqlServer);Database=$(sqlDatabase);Integrated Security=True;TrustServerCertificate=True;" `
            Microsoft.EntityFrameworkCore.SqlServer `
            --output-dir Entities `
            --context-dir . `
            --context HartonomousDbContext `
            --force `
            --no-build
          
          Write-Host "\u2713 Entities scaffolded"
        pwsh: true

# ============================================================================
# STAGE 4: BUILD .NET SOLUTION
# ============================================================================
- stage: BuildDotNet
  displayName: 'Build .NET Solution'
  dependsOn: ScaffoldEntities
  condition: succeeded()
  jobs:
  - job: BuildDotNetJob
    displayName: 'Build .NET Solution + CLR'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
        includePreviewVersions: true
        performMultiLevelLookup: true

    # Restore and build solution
    - task: PowerShell@2
      displayName: 'Restore and Build Solution'
      inputs:
        targetType: 'inline'
        script: |
          dotnet restore Hartonomous.sln
          dotnet build Hartonomous.sln --configuration Release --no-restore
        pwsh: true

    # Run unit tests
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      inputs:
        command: 'test'
        projects: 'tests/**/*Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx'
        publishTestResults: true

    # Publish applications
    - task: DotNetCoreCLI@2
      displayName: 'Publish Hartonomous.Api'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Api/Hartonomous.Api.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/api'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish CesConsumer'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.CesConsumer/Hartonomous.Workers.CesConsumer.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/ces-consumer'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish Neo4jSync'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.Neo4jSync/Hartonomous.Workers.Neo4jSync.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/neo4j-sync'
        zipAfterPublish: false

    # Copy deployment scripts
    - task: CopyFiles@2
      displayName: 'Copy Deployment Scripts'
      inputs:
        SourceFolder: 'scripts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/scripts'

    # Copy procedure files
    - task: CopyFiles@2
      displayName: 'Copy Stored Procedures'
      inputs:
        SourceFolder: 'src/Hartonomous.Database/Procedures'
        Contents: '**/*.sql'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/Procedures'

    # Publish .NET artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish .NET Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'dotnet'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 5: DEPLOY APPLICATIONS (Optional)
# ============================================================================
- stage: DeployApplications
  displayName: 'Deploy .NET Applications'
  dependsOn: BuildDotNet
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: AppDeployment
    displayName: 'Deploy Applications'
    pool:
      vmImage: 'windows-latest'
    environment: 'Application-Servers'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: dotnet

          - task: PowerShell@2
            displayName: 'Display Deployment Summary'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================"
                Write-Host "  Hartonomous Deployment Complete"
                Write-Host "========================================"
                Write-Host "Database: $(sqlServer)\$(sqlDatabase)"
                Write-Host ""
                Write-Host "Artifacts Ready for Deployment:"
                Write-Host "  - API: $(Pipeline.Workspace)/dotnet/api"
                Write-Host "  - CesConsumer: $(Pipeline.Workspace)/dotnet/ces-consumer"
                Write-Host "  - Neo4jSync: $(Pipeline.Workspace)/dotnet/neo4j-sync"
                Write-Host ""
                Write-Host "Next Steps:"
                Write-Host "  1. Configure service connections"
                Write-Host "  2. Deploy to target servers"
                Write-Host "  3. Configure application settings"
                Write-Host "  4. Run smoke tests"
                Write-Host "========================================"
              pwsh: true
