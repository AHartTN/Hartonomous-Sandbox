# ============================================================================
# Hartonomous Azure DevOps Pipeline
# Complete CI/CD for SQL Server Database + CLR + .NET 10 Applications
# Based on Microsoft Docs 2024/2025 Official Guidance
# ============================================================================

name: Hartonomous-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - docs/**
      - '*.md'
      - LICENSE

pool:
  name: 'Local Agent Pool'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetSdkVersion
    value: '10.x'
  - name: sqlServer
    value: 'localhost'
  - name: sqlDatabase
    value: 'Hartonomous'

stages:
# ============================================================================
# STAGE 1: BUILD DATABASE DACPAC ONLY
# ============================================================================
- stage: BuildDatabase
  displayName: 'Build Database DACPAC'
  jobs:
  - job: BuildDACPAC
    displayName: 'Build Database DACPAC'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
        performMultiLevelLookup: true
    
    # Build DACPAC using msbuild (agent must have MSBuild or Visual Studio)
    - task: PowerShell@2
      displayName: 'Build SQL Database Project with MSBuild'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/build-dacpac.ps1'
        arguments: '-ProjectPath "src/Hartonomous.Database/Hartonomous.Database.sqlproj" -OutputDir "$(Build.ArtifactStagingDirectory)/database/" -Configuration $(buildConfiguration)'
        pwsh: true
        
    # Verify DACPAC
    - task: PowerShell@2
      displayName: 'Verify DACPAC Build'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/verify-dacpac.ps1'
        arguments: '-DacpacPath "$(Build.ArtifactStagingDirectory)/database/Hartonomous.Database.dacpac"'
        pwsh: true

    # Copy external CLR dependencies
    - task: CopyFiles@2
      displayName: 'Copy External CLR Dependencies'
      inputs:
        SourceFolder: 'dependencies'
        Contents: '*.dll'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/dependencies'

    # Copy deployment scripts
    - task: CopyFiles@2
      displayName: 'Copy Deployment Scripts'
      inputs:
        SourceFolder: 'scripts'
        Contents: '*.ps1'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/scripts'

    # Publish database artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Database Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/database'
        artifact: 'database'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 2: DEPLOY DATABASE (DACPAC + EXTERNAL CLR)
# ============================================================================
- stage: DeployDatabase
  displayName: 'Deploy Database Schema'
  dependsOn: BuildDatabase
  condition: succeeded()
  jobs:
  - deployment: DatabaseDeployment
    displayName: 'Deploy to SQL Server'
    pool:
      name: 'Local Agent Pool'
    environment: 'SQL-Server-Production'
    strategy:
      runOnce:
        deploy:
          steps:
          # Download database artifact
          - download: current
            artifact: database

          # Step 0: Grant Pipeline Agent Permissions (Idempotent)
          - task: PowerShell@2
            displayName: 'Grant Agent Permissions'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/database/scripts/grant-agent-permissions.ps1'
              arguments: '-Server "$(sqlServer)"'
              pwsh: true

          # Step 1: Enable CLR Integration (Idempotent)
          - task: PowerShell@2
            displayName: 'Enable CLR Integration'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/database/scripts/enable-clr.ps1'
              arguments: '-Server "$(sqlServer)"'
              pwsh: true

          # Step 2: Deploy External CLR Assemblies
          - task: PowerShell@2
            displayName: 'Deploy External CLR Assemblies'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/database/scripts/deploy-clr-assemblies.ps1'
              arguments: '-Server "$(sqlServer)" -Database "$(sqlDatabase)" -DependenciesPath "$(Pipeline.Workspace)/database/dependencies"'
              pwsh: true

          # Step 3: Deploy DACPAC (includes Hartonomous.Clr.dll)
          - task: PowerShell@2
            displayName: 'Install SqlPackage'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/database/scripts/install-sqlpackage.ps1'
              pwsh: true
              
          - task: PowerShell@2
            displayName: 'Deploy DACPAC with Hartonomous.Clr Assembly'
            inputs:
              targetType: 'inline'
              script: |
                $ErrorActionPreference = 'Stop'
                $dacpacPath = "$(Pipeline.Workspace)/database/Hartonomous.Database.dacpac"
                $connectionString = "Server=$(sqlServer);Database=$(sqlDatabase);Integrated Security=False;User ID=$(sqlUsername);Password=$(sqlPassword);TrustServerCertificate=True;"
                
                Write-Host "Deploying DACPAC: $dacpacPath"
                Write-Host "This DACPAC includes Hartonomous.Clr.dll assembly embedded as hex binary"
                
                sqlpackage /Action:Publish `
                  /SourceFile:"$dacpacPath" `
                  /TargetConnectionString:"$connectionString" `
                  /p:DropObjectsNotInSource=False `
                  /p:BlockOnPossibleDataLoss=True `
                  /p:IgnorePreDeployScript=True `
                  /p:IgnorePostDeployScript=True
                
                if ($LASTEXITCODE -ne 0) { throw "DACPAC deployment failed" }
                Write-Host "âœ“ DACPAC deployed with Hartonomous.Clr assembly"
              pwsh: true

          # Step 4: Set TRUSTWORTHY ON (Idempotent)
          - task: PowerShell@2
            displayName: 'Set TRUSTWORTHY ON'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/database/scripts/set-trustworthy.ps1'
              arguments: '-Server "$(sqlServer)" -Database "$(sqlDatabase)"'
              pwsh: true

# ============================================================================
# STAGE 3: SCAFFOLD EF CORE ENTITIES
# ============================================================================
- stage: ScaffoldEntities
  displayName: 'Scaffold EF Core Entities'
  dependsOn: DeployDatabase
  condition: succeeded()
  jobs:
  - job: Scaffold
    displayName: 'Generate Entity Classes from DB'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
    
    # Scaffold entities from deployed database
    - task: PowerShell@2
      displayName: 'Scaffold EF Core Entities'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/scaffold-entities.ps1'
        arguments: '-Server "$(sqlServer)" -Database "$(sqlDatabase)" -ProjectPath "src/Hartonomous.Data.Entities"'
        pwsh: true

# ============================================================================
# STAGE 4: BUILD .NET SOLUTION
# ============================================================================
- stage: BuildDotNet
  displayName: 'Build .NET Solution'
  dependsOn: ScaffoldEntities
  condition: succeeded()
  jobs:
  - job: BuildDotNetJob
    displayName: 'Build .NET Solution + CLR'
    pool:
      name: 'Local Agent Pool'
    steps:
    # Install .NET 10 SDK
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'

    # Restore NuGet packages
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: 'Hartonomous.sln'
        feedsToUse: 'select'

    # Build solution
    - task: DotNetCoreCLI@2
      displayName: 'Build Solution (Release)'
      inputs:
        command: 'build'
        projects: 'Hartonomous.sln'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    # Run unit tests
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      inputs:
        command: 'test'
        projects: 'tests/**/*Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --logger trx'
        publishTestResults: true

    # Publish applications
    - task: DotNetCoreCLI@2
      displayName: 'Publish Hartonomous.Api'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Api/Hartonomous.Api.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/api'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish CesConsumer'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.CesConsumer/Hartonomous.Workers.CesConsumer.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/ces-consumer'
        zipAfterPublish: false

    - task: DotNetCoreCLI@2
      displayName: 'Publish Neo4jSync'
      inputs:
        command: 'publish'
        projects: 'src/Hartonomous.Workers.Neo4jSync/Hartonomous.Workers.Neo4jSync.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/neo4j-sync'
        zipAfterPublish: false

    # Copy deployment scripts
    - task: CopyFiles@2
      displayName: 'Copy Deployment Scripts'
      inputs:
        SourceFolder: 'scripts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/scripts'

    # Copy procedure files
    - task: CopyFiles@2
      displayName: 'Copy Stored Procedures'
      inputs:
        SourceFolder: 'src/Hartonomous.Database/Procedures'
        Contents: '**/*.sql'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/database/Procedures'

    # Publish .NET artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish .NET Artifacts'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'dotnet'
        publishLocation: 'pipeline'

# ============================================================================
# STAGE 5: DEPLOY APPLICATIONS (Optional)
# ============================================================================
- stage: DeployApplications
  displayName: 'Deploy .NET Applications'
  dependsOn: BuildDotNet
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: AppDeployment
    displayName: 'Deploy Applications'
    pool:
      vmImage: 'windows-latest'
    environment: 'Application-Servers'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: dotnet

          - task: PowerShell@2
            displayName: 'Display Deployment Summary'
            inputs:
              targetType: 'filePath'
              filePath: '$(Pipeline.Workspace)/dotnet/scripts/deployment-summary.ps1'
              arguments: '-Server "$(sqlServer)" -Database "$(sqlDatabase)" -ArtifactPath "$(Pipeline.Workspace)/dotnet"'
              pwsh: true
