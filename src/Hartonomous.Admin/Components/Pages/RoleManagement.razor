@page "/admin/roles"
@rendermode InteractiveServer

<PageTitle>Role Management</PageTitle>

<h1>Role Management</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowAddRoleForm">
        <i class="bi bi-plus-circle"></i> Add New Role
    </button>
</div>

@if (showAddForm)
{
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Add New Role</h5>
            <EditForm Model="newRole" OnValidSubmit="HandleAddRole">
                <DataAnnotationsValidator />
                <ValidationSummary />
                
                <div class="mb-3">
                    <label class="form-label">Role Name</label>
                    <InputText class="form-control" @bind-Value="newRole.Name" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <InputTextArea class="form-control" @bind-Value="newRole.Description" rows="3" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Permissions</label>
                    @foreach (var permission in availablePermissions)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   checked="@newRole.Permissions.Contains(permission)"
                                   @onchange="@(e => TogglePermission(permission, (bool)e.Value!))" />
                            <label class="form-check-label">@permission</label>
                        </div>
                    }
                </div>
                
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" @onclick="@(() => showAddForm = false)">Cancel</button>
            </EditForm>
        </div>
    </div>
}

<div class="row">
    @foreach (var role in roles)
    {
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@role.Name</h5>
                    <span class="badge bg-secondary">@role.UserCount users</span>
                </div>
                <div class="card-body">
                    <p class="card-text">@role.Description</p>
                    <h6>Permissions:</h6>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var permission in role.Permissions)
                        {
                            <span class="badge bg-info">@permission</span>
                        }
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => EditRole(role))">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="@(() => DeleteRole(role))" 
                            disabled="@(role.Name == "Admin")">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<RoleViewModel> roles = new();
    private RoleViewModel newRole = new() 
    { 
        Name = string.Empty,
        Description = string.Empty,
        Permissions = new List<string>()
    };
    private bool showAddForm = false;
    
    private List<string> availablePermissions = new()
    {
        "Users.Read",
        "Users.Write",
        "Users.Delete",
        "Roles.Read",
        "Roles.Write",
        "Roles.Delete",
        "Settings.Read",
        "Settings.Write",
        "Reports.View",
        "Reports.Export"
    };

    protected override void OnInitialized()
    {
        roles = new List<RoleViewModel>
        {
            new() 
            { 
                Id = 1, 
                Name = "Admin", 
                Description = "Full system access", 
                UserCount = 2,
                Permissions = new List<string>(availablePermissions)
            },
            new() 
            { 
                Id = 2, 
                Name = "User", 
                Description = "Standard user access", 
                UserCount = 15,
                Permissions = new List<string> { "Users.Read", "Reports.View" }
            },
            new() 
            { 
                Id = 3, 
                Name = "ReadOnly", 
                Description = "View-only access", 
                UserCount = 5,
                Permissions = new List<string> { "Users.Read", "Roles.Read", "Reports.View" }
            }
        };
    }

    private void ShowAddRoleForm()
    {
        newRole = new RoleViewModel 
        { 
            Name = string.Empty,
            Description = string.Empty,
            Permissions = new List<string>() 
        };
        showAddForm = true;
    }

    private void TogglePermission(string permission, bool isChecked)
    {
        if (isChecked && !newRole.Permissions.Contains(permission))
        {
            newRole.Permissions.Add(permission);
        }
        else if (!isChecked && newRole.Permissions.Contains(permission))
        {
            newRole.Permissions.Remove(permission);
        }
    }

    private void HandleAddRole()
    {
        newRole.Id = roles.Max(r => r.Id) + 1;
        roles.Add(newRole);
        showAddForm = false;
    }

    private void EditRole(RoleViewModel role)
    {
        // TODO: Implement edit functionality
    }

    private void DeleteRole(RoleViewModel role)
    {
        if (role.Name != "Admin")
        {
            roles.Remove(role);
        }
    }

    public class RoleViewModel
    {
        public int Id { get; set; }
        public required string Name { get; set; } = string.Empty;
        public required string Description { get; set; } = string.Empty;
        public int UserCount { get; set; }
        public required List<string> Permissions { get; set; } = new();
    }
}
