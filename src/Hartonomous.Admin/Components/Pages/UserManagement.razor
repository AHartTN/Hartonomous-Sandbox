@page "/admin/users"
@rendermode InteractiveServer

<PageTitle>User Management</PageTitle>

<h1>User Management</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowAddUserForm">
        <i class="bi bi-plus-circle"></i> Add New User
    </button>
</div>

@if (showAddForm)
{
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Add New User</h5>
            <EditForm Model="newUser" OnValidSubmit="HandleAddUser">
                <DataAnnotationsValidator />
                <ValidationSummary />
                
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="newUser.Email" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">First Name</label>
                    <InputText class="form-control" @bind-Value="newUser.FirstName" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Last Name</label>
                    <InputText class="form-control" @bind-Value="newUser.LastName" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <InputSelect class="form-select" @bind-Value="newUser.Role">
                        <option value="">Select a role...</option>
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                        <option value="ReadOnly">Read Only</option>
                    </InputSelect>
                </div>
                
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" @onclick="@(() => showAddForm = false)">Cancel</button>
            </EditForm>
        </div>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td>@user.Email</td>
                    <td>@user.FirstName @user.LastName</td>
                    <td>
                        <span class="badge bg-@(user.Role == "Admin" ? "danger" : "primary")">
                            @user.Role
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-@(user.IsActive ? "success" : "secondary")">
                            @(user.IsActive ? "Active" : "Inactive")
                        </span>
                    </td>
                    <td>@(user.LastLogin?.ToString("g") ?? "Never")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" @onclick="@(() => EditUser(user))">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => DeleteUser(user))">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<UserViewModel> users = new();
    private UserViewModel newUser = new() 
    { 
        Email = string.Empty,
        FirstName = string.Empty,
        LastName = string.Empty,
        Role = string.Empty
    };
    private bool showAddForm = false;

    protected override void OnInitialized()
    {
        // Mock data for demonstration
        users = new List<UserViewModel>
        {
            new() { Id = 1, Email = "admin@hartonomous.com", FirstName = "Admin", LastName = "User", Role = "Admin", IsActive = true, LastLogin = DateTime.Now.AddHours(-2) },
            new() { Id = 2, Email = "john.doe@example.com", FirstName = "John", LastName = "Doe", Role = "User", IsActive = true, LastLogin = DateTime.Now.AddDays(-1) },
            new() { Id = 3, Email = "jane.smith@example.com", FirstName = "Jane", LastName = "Smith", Role = "ReadOnly", IsActive = false, LastLogin = DateTime.Now.AddDays(-30) }
        };
    }

    private void ShowAddUserForm()
    {
        newUser = new UserViewModel 
        { 
            Email = string.Empty,
            FirstName = string.Empty,
            LastName = string.Empty,
            Role = string.Empty
        };
        showAddForm = true;
    }

    private void HandleAddUser()
    {
        newUser.Id = users.Max(u => u.Id) + 1;
        newUser.IsActive = true;
        users.Add(newUser);
        showAddForm = false;
        newUser = new UserViewModel 
        { 
            Email = string.Empty,
            FirstName = string.Empty,
            LastName = string.Empty,
            Role = string.Empty
        };
    }

    private void EditUser(UserViewModel user)
    {
        // TODO: Implement edit functionality
    }

    private void DeleteUser(UserViewModel user)
    {
        users.Remove(user);
    }

    public class UserViewModel
    {
        public int Id { get; set; }
        public required string Email { get; set; } = string.Empty;
        public required string FirstName { get; set; } = string.Empty;
        public required string LastName { get; set; } = string.Empty;
        public required string Role { get; set; } = string.Empty;
        public bool IsActive { get; set; }
        public DateTime? LastLogin { get; set; }
    }
}
