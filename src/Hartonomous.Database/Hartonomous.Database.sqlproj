<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- CRITICAL: Framework properties MUST come BEFORE imports for NuGet to detect correct version -->
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <TargetFrameworkVersion>v4.8.1</TargetFrameworkVersion>
    <TargetDatabaseSet>True</TargetDatabaseSet>
    <ProjectGuid>{4F7C8B3A-1234-5678-9ABC-DEF012345678}</ProjectGuid>
  </PropertyGroup>
  <Import Condition="'$(SQLDBExtensionsRefPath)' != ''" Project="$(SQLDBExtensionsRefPath)\Microsoft.Data.Tools.Schema.SqlTasks.targets" />
  <Import Condition="'$(SQLDBExtensionsRefPath)' == ''" Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v$(VisualStudioVersion)\SSDT\Microsoft.Data.Tools.Schema.SqlTasks.targets" />
  <ItemGroup>
    <Folder Include="Properties" />
    <Folder Include="Tables" />
    <Folder Include="Views" />
    <Folder Include="Functions" />
    <Folder Include="Procedures" />
    <Folder Include="Aggregates" />
    <Folder Include="Types" />
    <Folder Include="Schemas" />
    <Folder Include="Security" />
    <Folder Include="Migrations" />
    <Folder Include="Scripts" />
    <Folder Include="Scripts\Pre-Deployment" />
    <Folder Include="Scripts\Post-Deployment" />
    <Folder Include="CLR" />
    <Folder Include="ServiceBroker" />
    <Folder Include="ServiceBroker\Contracts" />
    <Folder Include="ServiceBroker\MessageTypes" />
    <Folder Include="ServiceBroker\Queues" />
    <Folder Include="ServiceBroker\Services" />
  </ItemGroup>
  <PropertyGroup>
    <Name>Hartonomous.Database</Name>
    <SchemaVersion>2.0</SchemaVersion>
    <ProjectVersion>4.1</ProjectVersion>
    <DSP>Microsoft.Data.Tools.Schema.Sql.Sql170DatabaseSchemaProvider</DSP>
    <RootPath>
    </RootPath>
    <RootNamespace>Hartonomous.Clr</RootNamespace>
    <AssemblyName>Hartonomous.Clr</AssemblyName>
    <ModelCollation>1033,CI</ModelCollation>
    <DefaultFileStructure>BySchemaAndSchemaType</DefaultFileStructure>
    <DeployToDatabase>True</DeployToDatabase>
    <TargetLanguage>CS</TargetLanguage>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <SqlServerVerification>False</SqlServerVerification>
    <IncludeCompositeObjects>True</IncludeCompositeObjects>
    <DefaultCollation>SQL_Latin1_General_CP1_CI_AS</DefaultCollation>
    <DefaultFilegroup>PRIMARY</DefaultFilegroup>
    <PlatformTarget>AnyCPU</PlatformTarget>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <OutputPath>bin\Debug\</OutputPath>
    <BuildScriptName>$(MSBuildProjectName).sql</BuildScriptName>
    <TreatWarningsAsErrors>False</TreatWarningsAsErrors>
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <DefineDebug>true</DefineDebug>
    <DefineTrace>true</DefineTrace>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <OutputPath>bin\Release\</OutputPath>
    <BuildScriptName>$(MSBuildProjectName).sql</BuildScriptName>
    <TreatWarningsAsErrors>False</TreatWarningsAsErrors>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <DefineDebug>false</DefineDebug>
    <DefineTrace>true</DefineTrace>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup>
    <VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">11.0</VisualStudioVersion>
    <SSDTExists Condition="Exists('$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v$(VisualStudioVersion)\SSDT\Microsoft.Data.Tools.Schema.SqlTasks.targets')">True</SSDTExists>
    <VisualStudioVersion Condition="'$(SSDTExists)' == ''">11.0</VisualStudioVersion>
  </PropertyGroup>
  <!-- CLR Integration Configuration -->
  <PropertyGroup>
    <EnableSqlClrDeployment>True</EnableSqlClrDeployment>
    <GenerateSqlClrDdl>True</GenerateSqlClrDdl>
    <SqlPermissionLevel>Unsafe</SqlPermissionLevel>
    <SqlClrAnyCpu>True</SqlClrAnyCpu>
    <SqlCLRVerifyCodeSecurity>False</SqlCLRVerifyCodeSecurity>
    <SignAssembly>true</SignAssembly>
    <AssemblyOriginatorKeyFile>CLR\SqlClrKey.snk</AssemblyOriginatorKeyFile>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <LangVersion>latest</LangVersion>
    <Deterministic>true</Deterministic>
    <DacVersion>1.0.0</DacVersion>
    <IgnoreTableOptions>False</IgnoreTableOptions>
    <IgnoreColumnOrder>True</IgnoreColumnOrder>
    <!-- Override SSDT's default /target:database for C# compiler -->
    <SqlClrBuildTarget>library</SqlClrBuildTarget>
    <!-- CRITICAL: Force PERMISSION_SET = UNSAFE in generated CREATE ASSEMBLY DDL -->
    <PermissionSet>UNSAFE</PermissionSet>
  </PropertyGroup>
  <!-- SQL Build Items (explicit includes for classic SSDT) -->
  <ItemGroup>
    <Build Include="Security\*.sql" />
    <Build Include="Schemas\*.sql" />
    <Build Include="Types\*.sql" />
    <Build Include="Tables\*.sql" />
    <Build Include="Indexes\*.sql" />
    <Build Include="Functions\*.sql" />
    <Build Include="Views\*.sql" />
    <Build Include="Procedures\*.sql" />
    <Build Include="Aggregates\*.sql" />
    <Build Include="ServiceBroker\Contracts\*.sql" />
    <Build Include="ServiceBroker\MessageTypes\*.sql" />
    <Build Include="ServiceBroker\Queues\*.sql" />
    <Build Include="ServiceBroker\Services\*.sql" />
    <None Include="Migrations\*.sql" />
  </ItemGroup>
  <ItemGroup>
    <!-- Exclude problematic migration/scripting files that need post-deployment handling -->
    <Build Remove="Tables\*Temporal*.sql" />
    <Build Remove="Tables\*_Migrate_*.sql" />
    <Build Remove="Tables\*_InMemory.sql" />
    <Build Remove="Tables\*Add_PseudoColumn*.sql" />
    <Build Remove="Tables\*AttentionGenerationTables.sql" />
    <Build Remove="Tables\*ProvenanceTrackingTables.sql" />
    <Build Remove="Tables\*ReasoningFrameworkTables.sql" />
    <Build Remove="Tables\*StreamOrchestrationTables.sql" />
    <Build Remove="Tables\*InferenceTracking.sql" />
    <Build Remove="Tables\*ModelStructure.sql" />
    <Build Remove="Procedures\*WeightRollback*.sql" />
    <Build Remove="Procedures\*SelfImprovement*.sql" />
    <Build Remove="Procedures\*InsertUsageRecord_Native*.sql" />
    <Build Remove="Procedures\*MigratePayload*.sql" />
    
    <!-- Exclude ingestion/extraction logic - belongs in Infrastructure/EF Core, not CLR -->
    <Build Remove="Procedures\dbo.sp_AtomizeModel.sql" />
    <Build Remove="Procedures\dbo.sp_AtomizeCode.sql" />
    <Build Remove="Procedures\dbo.sp_AtomIngestion.sql" />
    
    <!-- Exclude Pre-Deployment runtime scripts - referenced via :r in Script.PreDeployment.sql -->
    <Build Remove="Scripts\Pre-Deployment\Enable_*.sql" />
    <Build Remove="Scripts\Pre-Deployment\Setup_*.sql" />
    
    <!-- Exclude Post-Deployment runtime scripts - referenced via :r in Script.PostDeployment.sql -->
    <!-- Must list individual patterns since we need to keep Script.PostDeployment.sql -->
    <Build Remove="Scripts\Post-Deployment\graph.*.sql" />
    <Build Remove="Scripts\Post-Deployment\Temporal_*.sql" />
    <Build Remove="Scripts\Post-Deployment\TensorAtomCoefficients_*.sql" />
    <Build Remove="Scripts\Post-Deployment\zz_*.sql" />
    <Build Remove="Scripts\Post-Deployment\Seed*.sql" />
    <Build Remove="Scripts\Post-Deployment\Register*.sql" />
    <Build Remove="Scripts\Post-Deployment\Configure.*.sql" />
    <Build Remove="Scripts\Post-Deployment\Enable_*.sql" />
    <Build Remove="Scripts\Post-Deployment\Setup_*.sql" />
    <Build Remove="Scripts\Post-Deployment\Optimize_*.sql" />
    <Build Remove="Scripts\Post-Deployment\Common.*.sql" />
    <Build Remove="Scripts\Post-Deployment\Graph.*.sql" />
    
    <!-- Exclude legacy Procedures_Original folder if it exists -->
    <Build Remove="Procedures_Original\**\*.sql" />
  </ItemGroup>

  <!-- CLR C# Source Files - integrated directly into database project (no separate project needed) -->
  <ItemGroup>
    <!-- ONLY include production atomic decomposition extractors (no external dependencies) -->
    <Compile Include="CLR\ImagePixelExtractor.cs" />
    <Compile Include="CLR\AudioFrameExtractor.cs" />
    <Compile Include="CLR\AtomicStream.cs" />
    <Compile Include="CLR\AtomicStreamFunctions.cs" />
    <Compile Include="CLR\SqlBytesInterop.cs" />
    <Compile Include="CLR\BinaryConversions.cs" />
    <Compile Include="CLR\Properties\AssemblyInfo.cs" />
  </ItemGroup>
  <!-- Framework References for CLR -->
  <ItemGroup>
    <Reference Include="System" />
    <Reference Include="System.Data" />
    <Reference Include="System.Xml" />
    <Reference Include="System.Core" />
    <Reference Include="System.Drawing" />
    <Reference Include="System.Transactions" />
    <!-- Microsoft.SqlServer.Types loaded via PackageReference below -->
  </ItemGroup>
  <!--Nu Get package references for CLR dependencies -->
  <ItemGroup>
    <!-- ATOMIC EXTRACTORS ONLY: No external packages needed (use System.Drawing from GAC) -->
    <!-- MathNet, Newtonsoft.Json, SqlServer.Types removed - not required for Image/AudioFrameExtractor -->
  </ItemGroup>
  <!-- SQLCMD Variables for CLR deployment paths -->
  <ItemGroup>
    <SqlCmdVariable Include="DependenciesPath">
      <DefaultValue>D:\Repositories\Hartonomous\dependencies</DefaultValue>
      <Value>$(SqlCmdVar__DependenciesPath)</Value>
    </SqlCmdVariable>
    <SqlCmdVariable Include="SqlClrKeyPath">
      <DefaultValue>D:\Microsoft SQL Server\MSSQL17.MSSQLSERVER\MSSQL\CLR\SqlClrKey.snk</DefaultValue>
      <Value>$(SqlCmdVar__1)</Value>
    </SqlCmdVariable>
    <SqlCmdVariable Include="MathNetPath">
      <DefaultValue>D:\Microsoft SQL Server\MSSQL17.MSSQLSERVER\MSSQL\CLR\Dependencies\MathNet.Numerics.dll</DefaultValue>
      <Value>$(SqlCmdVar__2)</Value>
    </SqlCmdVariable>
  </ItemGroup>
  <!-- Deployment scripts -->
  <ItemGroup>
    <PreDeploy Include="Scripts\Pre-Deployment\Script.PreDeployment.sql" />
    <PostDeploy Include="Scripts\Post-Deployment\Script.PostDeployment.sql" />
  </ItemGroup>
</Project>